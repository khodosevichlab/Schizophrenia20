---
title: "Plots_Misha.Rmd"
author: "Rasmus Rydbirk"
date: "18 3 2021"
output: html_document
---

# Setup
```{r setup, include=FALSE}
library(cacoa)
library(magrittr)
library(ggtext)
library(org.Hs.eg.db)
library(dplyr)
library(HDF5Array)
library(tibble)
library(cowplot)
library(readr)
library(pheatmap)
library(reshape2)
library(clusterProfiler)
library(DOSE)
library(enrichplot)
library(pbapply)
require(ComplexHeatmap)
require(circlize)
library(ggplot2)
```

Load data
```{r}
anno <- readRDS("annotations_scz2.rds")
con <- readRDS("con.rds")
load("layer.info.RData")
high.pal <- high.pal[levels(annotations_scz2$high)]
med.pal <- med.pal[levels(annotations_scz2$med)]
```

Set sample groups
```{r}
sample.groups <- c(rep("CTRL",11), rep("SCHIZO",8)) %>% setNames(c('MB7', 'MB9', 'MB11', 'MB13', 'MB15', 'MB16', 'MB17', 'MB19', 'MB20', 'MB21', 'MB18-2', 'MB6', 'MB10', 'MB12', 'MB14', 'MB22', 'MB23','MB8-2', 'MB8'))
```

Create Cacoa objects
```{r}
inh.high <- anno$high.clean %>% levels() %>% .[grep("SST|VIP|ID2|PVALB", .)]
inh.med <- anno$med.clean %>% levels() %>% .[grep("SST|VIP|ID2|PVALB", .)]

cao.high <- Cacoa$new(con, sample.groups = sample.groups, n.cores=20, cell.groups=anno$high.clean, ref.level="CTRL", target.level="SCHIZO")

cao.high.inh <- Cacoa$new(con, sample.groups = sample.groups, n.cores=20, cell.groups=anno$high.clean %>% .[. %in% inh.high] %>% factor(), ref.level="CTRL", target.level="SCHIZO")

cao.high.exc <- Cacoa$new(con, sample.groups = sample.groups, n.cores=20, cell.groups=anno$high.clean %>% .[!. %in% inh.high] %>% factor(), ref.level="CTRL", target.level="SCHIZO")

cao.med <- Cacoa$new(con, sample.groups = sample.groups, n.cores=20, cell.groups=anno$med.clean, ref.level="CTRL", target.level="SCHIZO")

cao.med.inh <- Cacoa$new(con, sample.groups = sample.groups, n.cores=20, cell.groups=anno$med.clean %>% .[. %in% inh.med] %>% factor(), ref.level="CTRL", target.level="SCHIZO")

cao.med.exc <- Cacoa$new(con, sample.groups = sample.groups, n.cores=20, cell.groups=anno$med.clean %>% .[!. %in% inh.med] %>% factor(), ref.level="CTRL", target.level="SCHIZO")
```

# Figure 2C + S5C
```{r}
cao.high <- Cacoa$new(con, sample.groups = sample.groups, n.cores=20, cell.groups=anno$high.clean[anno$high.clean != "Glia"] %>% factor(), ref.level="CTRL", target.level="SCHIZO")

cao.high$plotCellLoadings() + theme(axis.text.y = element_markdown(size = 9)) + scale_fill_manual(values = high.pal)
```

## F2C
```{r}
res <- cao.high$test.results

cao.high$test.results$cda$balances %<>% .[rownames(.) %in% cao.high$test.results$cda.top.cells,]
cao.high$test.results$cda.top.cells <- NULL

col <- c("blue",
         "red",
         "red",
         "red",
         "blue",
         "blue",
         "red",
         "blue",
         "red",
         "red",
         "red",
         "blue",
         "red",
         "blue",
         "red") %>% rev()

p1 <- cao.high$plotCellLoadings() + theme(axis.text.y = element_markdown(size = 9, color = col)) + scale_fill_manual(values = high.pal)
pdf(file='F2C_high_clean.pdf',width=5,height=5); print(p1); dev.off();
```

## FS5C
```{r, fig.height=8, fig.width=6}
cao.high$test.results <- res

col.all <- c(rev(col), "red","blue","blue","red","blue","blue","blue","red","blue","blue","blue","blue","blue","blue","red","blue","blue","blue","red","red") %>% rev()

p1 <- cao.high$plotCellLoadings() + theme(axis.text.y = element_markdown(size = 9, color = col.all)) + scale_fill_manual(values = high.pal)
pdf(file='FS5C_high_clean.pdf',width=5,height=7); print(p1); dev.off();
```

# Figure 5A

Load data
```{r}
de.high.fixed <- readRDS("del.fixedW.rds")[["high"]]
```

```{r}
x <- lapply(de.high.fixed,function(x) sum(na.omit(x$res$pvalue<1e-3))) %>% unlist %>% sort
p1 <- ggplot(data.frame(cell=names(x),nde=x),aes(x=reorder(cell,nde),y=nde, fill=cell)) + geom_bar(stat="identity")+ ggthemes::theme_few() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),axis.title.x = element_blank(), legend.position="none") +ylab("# DE genes")  + scale_fill_manual(values = high.pal)

pdf("F5A_high_clean.pdf", width=8, height=5); print(p1); dev.off();
```

# Table S4 ???
```{r}
glist <- de.high.fixed %>% 
  names() %>% 
  lapply(function(x) {
    de.high.fixed[[x]]$res %>% 
      tibble::rownames_to_column("Gene") %>%
      filter(pvalue < 1e-3) %>% 
      mutate(Celltype = x)
  }) %>%
  bind_rows()

glist.exc <- glist[grepl("L2|L3|L4|L5", glist$Celltype),]
glist.inh <- glist[!grepl("L2|L3|L4|L5", glist$Celltype),]

write.table(glist.exc, "S4.exc.de.high.tsv", sep="\t", dec=",", row.names = T)
write.table(glist.inh, "S4.inh.de.high.tsv", sep="\t", dec=",", row.names = T)

```


# Prepare GO (fig. 6ABCD, table S6)
Prepare GO categories ... 
```{r}
 go_datas <- c("BP", "CC", "MF") %>% setNames(., .) %>%
   pblapply(function(n) clusterProfiler:::get_GO_data(org.Hs.eg.db, n, "ENTREZID") %>%
              as.list() %>% as.environment()) # otherwise it pass reference to the environment content
```

Run enrichment tests
```{r}
enrichGOOpt <- function (gene, OrgDB, goData, keyType = "ENTREZID", ont = "MF", pvalueCutoff = 0.05,
                         pAdjustMethod = "BH", universe=NULL, qvalueCutoff = 0.2, minGSSize = 10,
                         maxGSSize = 500, readable = FALSE, pool = FALSE) {
  ont %<>% toupper %>% match.arg(c("BP", "CC", "MF"))

  res <- clusterProfiler:::enricher_internal(gene, pvalueCutoff = pvalueCutoff,
                                             pAdjustMethod = pAdjustMethod, universe = universe,
                                             qvalueCutoff = qvalueCutoff, minGSSize = minGSSize,
                                             maxGSSize = maxGSSize, USER_DATA = goData)
  if (is.null(res))
    return(res)

  res@keytype <- keyType
  res@organism <- clusterProfiler:::get_organism(OrgDB)
  if (readable) {
    res <- DOSE::setReadable(res, OrgDB)
  }
  res@ontology <- ont

  return(res)
}

distanceBetweenTerms <- function(go.df) {
  genes.per.go <- sapply(go.df$geneID, strsplit, "/") %>% setNames(go.df$Description)
  all.go.genes <- unique(unlist(genes.per.go))
  all.gos <- unique(go.df$Description)

  genes.per.go.mat <- matrix(0, length(all.go.genes), length(all.gos)) %>%
    `colnames<-`(all.gos) %>% `rownames<-`(all.go.genes)

  for (i in 1:length(genes.per.go)) {
    genes.per.go.mat[genes.per.go[[i]], go.df$Description[[i]]] <- 1
  }

  return(dist(t(genes.per.go.mat), method="binary"))
}

```

```{r}
calculate.gos <- function(de,n.top.genes=300,n.cores=1) {
  de <- de[unlist(lapply(de,is.list))]
  
  # add Z scores
  de <- lapply(de,function(d) {
    res.table <- d$res;
    res.table$Z <- -qnorm(res.table$pval/2)
    res.table$Z[is.na(res.table$Z)] <- 0
    res.table$Za <- -qnorm(res.table$padj/2)
    res.table$Za[is.na(res.table$Za)] <- 0
    res.table$Z <- res.table$Z  * sign(res.table$log2FoldChange)
    res.table$Za <- res.table$Za  * sign(res.table$log2FoldChange)
    d$res <- res.table;
    d
  })
  
  
  gns <- list(down=lapply(de,function(x) rownames(x$res)[order(x$res$Z,decreasing=F)[1:n.top.genes]]),
              up=lapply(de,function(x) rownames(x$res)[order(x$res$Z,decreasing=T)[1:n.top.genes]]),
              all=list(all=unique(unlist(lapply(de,function(x) rownames(x$res))))))
  
  gns.entrez <- lapply(gns,function(x) lapply(x, bitr, 'SYMBOL', 'ENTREZID', org.Hs.eg.db) %>% lapply(`[[`, "ENTREZID"))
  
  gos <- lapply(gns.entrez[c('up','down')],function(gns) {
    lapply(gns,enrichGOOpt,universe=gns.entrez$all$all, ont='BP', goData=go_datas[['BP']], readable=T, OrgDB=org.Hs.eg.db)
  })
  
}

gos.cluster <- function(gos,n.clusters=20,max.pval=0.05) {
  gos_filt <- lapply(gos,function(x) filter(x@result,p.adjust<max.pval))
  gos_joint <- do.call(rbind,gos_filt)
  
  gos_joint <- gos_filt %>% .[sapply(., nrow) > 0] %>% names() %>% setNames(., .) %>% lapply(function(n) cbind(gos_filt[[n]],Type=n)) %>% Reduce(rbind,.)
  go_dist <- distanceBetweenTerms(gos_joint)
  clusts <- hclust(go_dist,method='ward.D2') %>% cutree(n.clusters)
  gos_per_clust <- split(names(clusts), clusts)
  ngos_per_clust <- sapply(gos_per_clust, length)
  
  gos_per_clust <- split(names(clusts), clusts)
  gos_joint %<>% mutate(GOClust=clusts[Description])
  name_per_clust <- gos_joint %>% group_by(GOClust, Description) %>% summarise(pvalue=exp(mean(log(pvalue)))) %>% 
    split(.$GOClust) %>% sapply(function(df) df$Description[which.min(df$pvalue)])
  gos_joint %<>% mutate(GOClustName=name_per_clust[as.character(GOClust)])
  
  # cluster summary
  go_bp_summ_df <- gos_joint %>% group_by(Type, GOClustName) %>% 
    summarise(p.adjust=min(p.adjust)) %>% ungroup() %>% mutate(p.adjust=-log10(p.adjust)) %>% 
    tidyr::spread(Type, p.adjust) %>% as.data.frame() %>% set_rownames(.$GOClustName) %>% .[, 2:ncol(.)]
  go_bp_summ_df[is.na(go_bp_summ_df)] <- 0
  
  return(list(joint=gos_joint,clusters=clusts,summary=go_bp_summ_df))
}

```

Calculate enrichments
```{r}
delW <- list(med=readRDS("/home/rasmusr/schizo_plots/de.med.wald.rds"),
             high=readRDS("/home/rasmusr/schizo_plots/de.high.wald.rds"))
goslW <- lapply(delW,calculate.gos,n.top.genes=500)
saveRDS(goslW, "goslW.rds", compress=F)
```

## Figure 6AB
```{r}
goslW.s9 <- goslW %>% lapply(lapply, function(x) x) %>% .["high"] %>% .[[1]]
res.s9 <- goslW.s9 %>% 
  names() %>%
  lapply(function(dir) {
    goslW.s9[[dir]] %>% names() %>%
      lapply(function(type) {
        goslW.s9[[dir]][[type]]@result %>% 
          filter(p.adjust < 0.05) %>% 
          mutate(Type=type, Direction=dir) %>% 
          {if(nrow(.) < 4) . else .[1:3,]}
      })
  }) %>% 
  do.call(c, .) %>%
  .[sapply(., nrow) > 0] %>% 
  do.call(rbind, .) %>%
  .[order(.$p.adjust, decreasing=T),]

res.s9.up <- res.s9 %>% filter(Direction == "up")
res.s9.down <- res.s9 %>% filter(Direction == "down")
```

### Up (B)
```{r}
res.s9.up$Description %<>% make.unique()
res.s9.up$Description %<>% factor(., levels=.)
res.s9.up$p.adjust %<>% log10() %>% {. * -1}
```

```{r}
p1 <- ggplot(res.s9.up, aes(p.adjust, Description, fill=Type)) + 
  geom_bar(stat="identity") +
  theme_bw() +
  labs(x="-log10(adj. P)", y="", fill="Cell type", title="Top GO terms for up-regulated DE genes") +
  geom_vline(xintercept = 1.3, linetype="dotted") + scale_fill_manual(values = high.pal)

pdf(file='F6B_high_clean.pdf',width=8,height=5); print(p1); dev.off();
```

### Down (A)
```{r}
res.s9.down$Description %<>% make.unique()
res.s9.down$Description %<>% factor(., levels=.)
res.s9.down$p.adjust %<>% log10() %>% {. * -1}
```

```{r, fig.height=12, fig.width=8}
p1 <- ggplot(res.s9.down, aes(p.adjust, Description, fill=Type)) + 
  geom_bar(stat="identity") +
  theme_bw() +
  labs(x="-log10(adj. P)", y="", fill="Cell type", title="Top GO terms for down-pregulated DE genes") +
  geom_vline(xintercept = 1.3, linetype="dotted") + scale_fill_manual(values = high.pal)

pdf(file='F6A_high_clean.pdf',width=12,height=12); print(p1); dev.off();
```

# Table S6 ???
```{r}
write.table(res.s9.down, "S6_GO_down.tsv", sep="\t", dec=",")
write.table(res.s9.up, "S6_GO_up.tsv", sep="\t", dec=",")
```

# Figure 6

## Figure 6CD

Load data
```{r}
pardinas <- read.table("Pardinas2018_suppl-table4.txt", header = F, sep = "\t") %>% 
  .[-1,] %>% 
  sapply(function(x) x[x != ""]) %>% 
  unlist() %>% 
  unique()

pubsqueezer <- read.table("pubsqueezer.tsv", header = F, sep = "\t")
sfari <- read.table("SFARI_genes.csv", header = F, sep = ",") %>% .[,1]
psygenet <- read.table("PsyGeNET_genes.csv", header = F, sep=",") %>% .[,1] # Actually DisGeNET database

de.high <- readRDS("/home/rasmusr/schizo_plots/de.high.wald.rds")
```

Function
```{r}
overrep.test <- function(n, gene.set) {
  high.top <- de.high %>%
    .[!sapply(., is.logical)] %>%
    lapply(`[[`, 1) %>%
    lapply(function(x) {
      x %>%
        .[complete.cases(.),] %>%
        .[1:n,]
      }) %>%
    .[sapply(., nrow) > 0] %>%
    lapply(rownames)
  
  high.olap <- high.top %>%
    lapply(function(x) sum(x %in% gene.set))
  
  high.p <- lapply(high.olap, function(x) phyper(x-1, length(gene.set), (3e4-length(gene.set)), n, lower.tail=F)) # 3e4 /home/rasmusr number of human genes
  
  message(paste0("Number of significant overrep. cell types: ", sum(high.p <= 0.05, na.rm = T)))
  message(paste0("Significant cell types (ordered): \n"))
  message(paste0(high.p %>% unlist() %>% .[order(.)] %>% .[. <= 0.05] %>% .[!is.na(.)] %>% names(), collapse="\n"))
  
  return(high.p)
}
```

### MISHA, if you don't mention overrep with 100 genes, please remove those lines. Same goes for pubsqueezer and comparison with Pardinas2018

### Test, sfari
```{r}
top100 <- overrep.test(100, sfari)
top500.sfari <- overrep.test(500, sfari)
```

### Test, Pardinas
```{r}
top100 <- overrep.test(100, pardinas)
top500 <- overrep.test(500, pardinas)
```

### Test, DisGeNET (Psygenet)
```{r}
top100 <- overrep.test(100, psygenet)
top500.psygenet <- overrep.test(500, psygenet)
```

### Test, pubsqueezer
```{r}
top100 <- overrep.test(100, pubsqueezer$V1)
top500 <- overrep.test(500, pubsqueezer$V1)
```

### Plot
Sfari
```{r}
plot.data <- top500.sfari %>% unlist() %>% as.data.frame() %>% setNames("p") %>% mutate(cell=rownames(.)) %>% .[order(.$p, decreasing = T),]
plot.data$cell %<>% factor(., levels=.)
plot.data$p %<>% p.adjust() %>% log10() %>% {. * -1}

plot.sfari <- ggplot(plot.data, aes(p, cell, fill=cell)) + 
  geom_bar(stat="identity") +
  theme_bw() +
  labs(x="-log10(adj. P)", y="", fill="Cell type", title="SFARI") +
  geom_vline(xintercept = -log10(0.05), linetype="dotted") +
  # geom_vline(xintercept = -log10(0.05/length(top500.sfari)), linetype="dotted", colour = "red") +
  theme(legend.position = "none") + scale_fill_manual(values = high.pal) +
  xlim(c(-1,4))

plot.sfari
```

```{r}
plot.data <- top500.psygenet %>% unlist() %>% as.data.frame() %>% setNames("p") %>% mutate(cell=rownames(.)) %>% .[order(.$p, decreasing = T),]
plot.data$cell %<>% factor(., levels=.)
plot.data$p %<>% p.adjust() %>% log10() %>% {. * -1}

plot.psygenet <- ggplot(plot.data, aes(p, cell, fill=cell)) + 
  geom_bar(stat="identity") +
  theme_bw() +
  labs(x="-log10(adj. P)", y="", fill="Cell type", title="DisGeNET") +
  geom_vline(xintercept = -log10(0.05), linetype="dotted") +
  # geom_vline(xintercept = -log10(0.05/length(top500.psygenet)), linetype="dotted", colour = "red") +
  theme(legend.position = "none") + scale_fill_manual(values = high.pal)

plot.psygenet
```

```{r}
pdf(file = "F6D_SFARI_overrep.pdf", width = 4, height = 5)
plot.sfari
dev.off()

pdf(file = "F6C_DisGeNET_overrep.pdf", width = 4, height = 5)
plot.psygenet
dev.off()
```

## Figure 6E

### CELLEX

Prepare data
```{r}
cm.merged.raw <- con$getJointCountMatrix(raw=T)
```

Translate gene symbols to Ensembl IDs
```{r}
gnames <- clusterProfiler::bitr(geneID = colnames(cm.merged.raw), fromType = "SYMBOL", toType = "ENSEMBL", OrgDb = org.Hs.eg.db)
gnames %<>% .[match(unique(.$SYMBOL), .$SYMBOL),] %>% .[match(unique(.$ENSEMBL), .$ENSEMBL),]
```

```{r}
cm.merged.raw %<>% .[,match(gnames$SYMBOL, colnames(.))]
colnames(cm.merged.raw) <- gnames$ENSEMBL
```

For all cells
```{r}
cell.groups <- anno$high.clean %>%
  as.character() %>%
  setNames(names(anno$high.clean)) %>%
  .[match(rownames(cm.merged.raw),names(.))] %>%
  cbind() %>% 
  data.frame(stringsAsFactors = F) %>% 
  tibble::rownames_to_column() %>% 
  setNames(c("cell_id","cell_type"))

cell.groups$cell_id %<>% gsub(".", "-", ., fixed = T)
```

Isolate SZ cells
```{r}
sample.per.cell <- con$getDatasetPerCell()
scz.cells <- sample.per.cell[sample.per.cell %in% names(sample.groups[sample.groups == "SCHIZO"])] %>% factor()
groups.scz <- cell.groups %>% .[.$cell_id %in% names(scz.cells),]
scz.cm <- cm.merged.raw %>% .[rownames(.) %in% groups.scz$cell_id,]
```

Save data for Python
```{r}
writeHDF5Array(cm.merged.raw, "/home/rasmusr/CELLEX/data.scz.h5", "data", verbose = T)

write.csv(cm.merged.raw %>% colnames(), "/home/rasmusr/CELLEX/genes.scz.csv", row.names = F)
write.csv(cm.merged.raw %>% rownames(), "/home/rasmusr/CELLEX/cells.scz.csv", row.names = F)
write.csv(groups.scz, "/home/rasmusr/CELLEX/metadata.scz.csv", row.names = F)
```

Python (run on Ada)
cd /home/rasmusr/CELLEX
python

import numpy as np
import pandas as pd
import cellex
import h5py

data = pd.DataFrame(np.array(h5py.File("data.scz.h5")['data']), dtype="float32")
data.columns = pd.read_csv("./cells.scz.csv").values
data.columns = [v[0] for v in data.columns]
data.index = pd.read_csv("./genes.scz.csv").values
data.index = [v[0] for v in data.index]

metadata = pd.read_csv("./metadata.scz.csv", index_col=0)

eso = cellex.ESObject(data=data, annotation=metadata, verbose=True)
eso.compute(verbose=True)

eso.results["esmu"].to_csv("Cellex.scz.results.csv.gz")

### CELLECT

SZ data
https://atlas.ctglab.nl/traitDB/3982

```{r}
dat <- readr::read_tsv("CELLECT/Pardinas2018_clean.txt", progress = T)
```

Munging

cd /home/rasmusr/CELLECT
conda activate munge_ldsc

python ldsc/mtag_munge.py \
--sumstats Pardinas2018/Pardinas2018_clean.tsv \
--a1 A1 \
--a2 A2 \
--merge-alleles data/ldsc/w_hm3.snplist \
--keep-pval \
--p PVAL \
--N-cas 40675 \
--N-con 64643 \
--out Pardinas2018/Pardinas2018

Run CELLECT LDSC
conda activate base
snakemake --use-conda -j 20 -s cellect-ldsc.snakefile --configfile example/config_SCZ.yml

```{r}
dat.ld <- read.csv("CELLECT/CELLECT-LDSC/prioritization.csv")
```

```{r}
dat.ld %<>% dplyr::mutate(type="LD") %>% .[order(.$annotation),]

p.cutoff <- 0.05/nrow(dat.ld)

cellect <- ggplot(dat.ld, aes(annotation, pvalue, col=annotation)) + 
  geom_point() +
  labs(x="", y="P value") +
  geom_hline(yintercept = 0.05, col = "black", linetype = "dotted") +
  geom_hline(yintercept = p.cutoff, col = "red", linetype = "dotted") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90), legend.position = "none", axis.text.y = element_text(colour = ifelse(dat.ld$pvalue <= p.cutoff, "red", "black"))) +
  coord_flip() + 
  scale_color_manual(values = dat.ld$pvalue %>% sapply(function(x) {
    if(x <= p.cutoff) return("red") else if(x > p.cutoff & x <= 0.05) return("gray") else return("black")
  }) %>% setNames(dat.ld$annotation)) 

cellect

pdf(file = "F6E_CELLECT.pdf", width = 5, height = 5)
cellect
dev.off()
```