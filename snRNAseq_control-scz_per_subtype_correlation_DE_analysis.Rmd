---
title: "Schizo figures"
output:
  html_notebook:
    toc: true
    toc_float: true
---

Misha, to get started, you'll need to:
1. Update your conos install, using 'dev' branch


```{r}
library(pagoda2)
library(dplyr)
library(conos)
library(parallel)
library(cowplot)
library(ggrepel)
library(Matrix)
source("/home/pkharchenko/m/pavan/DLI/conp2.r")
library(cacoa)
```

Load original embedding and annotation:
```{r}
con <- Conos$new(readRDS("~pkharchenko/konstantin/schizo/repro/con.rds"))
```

Sample annotations:
```{r}
load("~pkharchenko/konstantin/schizo/annotations.RData")
combf <- as.factor(combf)
# removing MB8
samplegroups <- list(
  control = c('MB7', 'MB9', 'MB11', 'MB13', 'MB15', 'MB16', 'MB17', 'MB19', 'MB20', 'MB21', 'MB18-2'),
  schizo = c('MB6', 'MB10', 'MB12', 'MB14', 'MB22', 'MB23','MB8-2')
)
diseasef <- as.factor(setNames(rep(names(samplegroups),unlist(lapply(samplegroups,length))),unlist(samplegroups)))

# on per-cell basis
celldiseasef <- con$getDatasetPerCell()
celldiseasef <- setNames(diseasef[celldiseasef],names(celldiseasef))
```


Doublet scores
```{r}
scrubletf <- readRDS("~pkharchenko/konstantin/schizo/repro/scrubletf.rds")
```


Cell annotations
```{r}
tans <- readRDS("~pkharchenko/konstantin/schizo/repro/tans.rds")
# fix cluster names
tans$high <- gsub("Pvalb_Nos1","Pvalb_Sst",gsub("L5_6_Fezf2_Lrrk1","L4_5_Fezf2_Lrrk1",tans$high))


# define a more extensive "Other" population
x <- pagoda2::readPagoda2SelectionFile("~pkharchenko/konstantin/schizo/repro/figures/unknown.cells.pagoda2")
tans$high[names(tans$high) %in% x[[1]]$cells] <- "Other"
tans$med[names(tans$med) %in% x[[1]]$cells] <- "Other"

# Sept'20 annotations
tans <- readRDS("~mbatiuk/projects/human_schizo/MB6-MB23/2ndary/ctx_layers_SCZ_ALLEN/rds_objects/annotations_scz2.rds")

# define "neural only" annotations that remove Glia, Other and potential doublets
tans$med.clean <- tans$med[!grepl("Glia|Other",tans$med)]
tans$high.clean <- tans$high[!grepl("Glia|Other",tans$high)]

tans$med.clean <- tans$med.clean[! names(tans$med.clean) %in% names(scrubletf)[scrubletf>0.25]]
tans$high.clean <- tans$high.clean[! names(tans$high.clean) %in% names(scrubletf)[scrubletf>0.25]]

# make into factors
tans <- lapply(tans,as.factor)

```



Define consistent palletes (named vectors of colors):
```{r}
set.seed(0)
high.pal <- setNames(sample(rainbow(length(levels(tans$high)),s=1,v=0.9)),levels(tans$high))
med.pal <- setNames(sample(rainbow(length(levels(tans$med)))),levels(tans$med))
```

Load Misha's pallets and layer definitions
```{r}
load("layer.info.RData")
high.pal <- high.pal[levels(annotations_scz2$high)]
med.pal <- med.pal[levels(annotations_scz2$med)]
```


# Fig 1
Embedding overview figures, showing annotations, samples, healthy/control, etc.

Full Med res annotation (note rasterization options)
```{r fig.height=5,fig.width=5}
p1 <- con$plotGraph(alpha=0.1,size=0.1,groups=tans$med,font.size=c(3,5),raster=T,raster.height=5,raster.width=5,plot.na=F,palette=med.pal)
pdf(file='med.annot.pdf',width=5,height=5); print(p1); dev.off();
p1
``` 



Cleaned version:

```{r fig.height=5,fig.width=5}
p1 <- con$plotGraph(alpha=0.1,size=0.1,groups=tans$med.clean,font.size=c(3,5),raster=T,raster.height=5,raster.width=5,plot.na=F,palette=med.pal)
pdf(file='med.clean.annot.pdf',width=5,height=5); print(p1); dev.off();
p1
``` 


```{r fig.height=5,fig.width=5}
p1 <- con$plotGraph(alpha=0.1,size=0.1,groups=tans$med.clean,font.size=c(3,5),raster=T,raster.height=5,raster.width=5,plot.na=F,palette=med.pal)+theme_void()+guides(color=FALSE)
#pdf(file='med.clean.annot.pdf',width=5,height=5); print(p1); dev.off();
p1
``` 


High res (cleaned)
```{r fig.height=5,fig.width=5}
p1 <- con$plotGraph(alpha=0.1,size=0.1,groups=tans$high.clean,font.size=c(3,4),raster=T,raster.height=5,raster.width=5,plot.na=F,palette=high.pal)
pdf(file='high.annot.pdf',width=5,height=5); print(p1); dev.off();
p1
``` 

Show sample distribution in the embedding
```{r fig.height=5,fig.width=10}
rpal <- function(n) sample(rainbow(n))
p1 <- con$plotGraph(alpha=0.1,size=0.1,groups=tans$med,font.size=c(3,5),raster=T,plot.na=F,palette=med.pal)
p2 <- con$plotGraph(alpha=0.05,size=0.1,color.by='sample',font.size=c(3,5),raster=T,plot.na=F,palette=rpal,mark.groups=F)
plot_grid(plotlist=list(p1,p2),nrow=1)
``` 




```{r fig.height=5,fig.width=10}
rpal <- function(n) sample(rainbow(n))
dpal <- c('control'='dodgerblue1','schizo'='indianred1')
dpalf <- function(n) dpal
p1 <- con$plotGraph(alpha=0.1,size=0.1,groups=tans$med.clean,font.size=c(3,5),raster=T,plot.na=F,palette=med.pal,raster.width=4,raster.height=4)
p2 <- con$plotGraph(alpha=0.02,size=0.1,groups=celldiseasef[names(celldiseasef) %in% names(tans$med.clean)],font.size=c(3,5),raster=T,raster.width=4,raster.height=4,plot.na=F,mark.groups=F,palette=dpalf)+ theme(legend.position=c(0.85, 0.15)) + guides(color=guide_legend(override.aes = list(size=3,alpha=0.8),title=''))
pg <- plot_grid(plotlist=list(p1,p2),nrow=1)
pdf(file='schizo.cont.colors.pdf',width=8,height=4); print(pg); dev.off();
pg
``` 


Plot individual samples using joint embedding
```{r fig.height=10, fig.width=2}
pp <- con$plotPanel(groups=tans$med,plot.na=F,alpha=0.1,size=0.2,use.common.embedding = T, ncol=2, mark.groups=F,palette=med.pal,raster=T, raster.width=1,raster.height=1,title.size=4)
#pdf('panel.pdf',height=8,width=2); print(pp); dev.off();
pp
```

# Heatmaps
Run differential expression for both high and low-resolution cases to determine marker genes

Marker genes:

```{r}
# note: if you're running in Rstudio, you might want to paste this command into the R prompt directly - R notebook sometimes gets hung up on large parallel jobs like this
# we'll downsample the cells from each subpopulation to reduce the amount of calculation that needs to be performed
max.cells <- 1e3; # maximum number of cells per population
set.seed(0)
sampled.cells <- unlist(tapply(names(tans$med),tans$med,function(x) sample(x,min(length(x),max.cells))))
med.de <- con$getDifferentialGenes(groups=tans$med[sampled.cells],n.cores=30,append.auc=TRUE,z.threshold=0,upregulated.only=T)
```


Heatmap of marker genes ... first we output a large version into a pdf so that we can read the gene names there
```{r fig.width=7,fig.height=12}
#source("~/m/p2/conos/R/plot.R")
pp <- plotDEheatmap(con,tans$med,med.de,n.genes.per.cluster = 10 ,show.gene.clusters=T,column.metadata=list(samples=con$getDatasetPerCell(),disease=celldiseasef),order.clusters = T,use_raster=T,raster_device = "CairoPNG", column.metadata.colors = list(clusters=med.pal,disease=dpal),row.label.font.size = 8)
pdf(file='med.heatmap.pdf',width=10,height=30); print(pp); dev.off();
pp
```

It looks like we'd be better off running this without "Other" ... let's do that.
```{r}
max.cells <- 1e3; # maximum number of cells per population
set.seed(0)
fac <- tans$med; fac<- fac[!fac %in% c("Other")]; fac <- droplevels(fac);
sampled.cells <- unlist(tapply(names(fac),fac,function(x) sample(x,min(length(x),max.cells))))

med.de2 <- con$getDifferentialGenes(groups=fac[sampled.cells],n.cores=30,append.auc=TRUE,z.threshold=0,upregulated.only=T)
```


Heatmap of marker genes ... first we output a large version into a pdf so that we can read the gene names there
```{r fig.width=7,fig.height=12}
#source("~/m/p2/conos/R/plot.R")
pp <- plotDEheatmap(con,fac,med.de2,n.genes.per.cluster = 10 ,show.gene.clusters=T,column.metadata=list(samples=con$getDatasetPerCell(),disease=celldiseasef),order.clusters = T,use_raster=T,raster_device = "CairoPNG", column.metadata.colors = list(clusters=med.pal,disease=dpal),row.label.font.size = 8,raster_by_magick = F)
pdf(file='med.heatmap2.pdf',width=10,height=30); print(pp); dev.off();
pp
```

Not very clean .. you may want to combine certain annotations for the purposes of showing marker genes

A small version of the hetmap, for the main figure, showing only select genes.
Also, we only show the "sampled.cells", which makes the proportion of different cell types equal, but in turn makes it easier to see the expression patterns (and faster to draw)
```{r fig.width=6,fig.height=6}
genes <- c("PLP1",'CUX2','MEIS2','NRP1','FOXP2','TLL1','LRRK1','TLE4','KIT','VIP','ANK1','PLCH1')
# note: additional.genes allows one to add genes to the map 
# labeled.gene.subset makes sure that only the listed genes are named
# min.auc filters for high AUC genes
pp <- plotDEheatmap(con,fac[sampled.cells],med.de2,n.genes.per.cluster = 20 ,show.gene.clusters=T,column.metadata=list(samples=con$getDatasetPerCell(),disease=celldiseasef),order.clusters = T,column.metadata.colors = list(clusters=med.pal,disease=dpal),row.label.font.size = 8, additional.genes = genes, labeled.gene.subset = genes, min.auc = 0.79, use_raster=T,raster_device = "CairoPNG",raster_by_magick = F)
pp
```



We can also calculate a more detailed set of makers for, let's say, inhibitory neurons only
```{r}
#inh.cells <- names(tans$med.clean)[tans$med.clean %in% grep("^Id|^Pval|^Sst|^Vip",levels(tans$med.clean),val=T)]
inh.cells <- names(tans$med.clean)[tans$med.clean %in% grep("^ID|^PVAL|^SST|^VIP",levels(tans$med.clean),val=T)]
max.cells <- 1e3; # maximum number of cells per population
set.seed(0)
inh.fac <- tans$high.clean; inh.fac <- inh.fac[names(inh.fac) %in% inh.cells]; inh.fac <- droplevels(inh.fac);
inh.sampled.cells <- unlist(tapply(names(inh.fac),inh.fac,function(x) sample(x,min(length(x),max.cells))))

inh.de <- con$getDifferentialGenes(groups=inh.fac[inh.sampled.cells],n.cores=30,append.auc=TRUE,z.threshold=0,upregulated.only=T)
```

```{r fig.width=7,fig.height=12}
pp <- plotDEheatmap(con,inh.fac[inh.sampled.cells],inh.de,n.genes.per.cluster = 10, show.gene.clusters=T,column.metadata=list(samples=con$getDatasetPerCell(),disease=celldiseasef),order.clusters = T,use_raster=T,raster_device = "CairoPNG", column.metadata.colors = list(clusters=high.pal,disease=dpal),row.label.font.size = 8,raster_by_magick = F)
pp
```


# Expression shift magntiude

```{r}
source("~pkharchenko/m/p2/comp/cacoa/R/expression_shifts.R")
require(magrittr)

sgf <- setNames(rep(names(samplegroups),unlist(lapply(samplegroups,length))),unlist(samplegroups))

xMed <- estimateExpressionShiftMagnitudes(lapply(con$samples,conos:::getRawCountMatrix),sample.groups=sgf,cell.groups=tans$med.clean,dist='JS',n.cells=500,n.subsamples=100,min.cells=10,n.cores=30) 
xMedc <- estimateExpressionShiftMagnitudes(lapply(con$samples,conos:::getRawCountMatrix),sample.groups=sgf,cell.groups=tans$med.clean,dist='cor',n.cells=500,n.subsamples=100,min.cells=10,n.cores=30) 

xHi <- estimateExpressionShiftMagnitudes(lapply(con$samples,conos:::getRawCountMatrix),sample.groups=sgf,cell.groups=tans$high.clean,dist='JS',n.cells=500,n.subsamples=100,min.cells=10,n.cores=30) 
xHic <- estimateExpressionShiftMagnitudes(lapply(con$samples,conos:::getRawCountMatrix),sample.groups=sgf,cell.groups=tans$high.clean,dist='cor',n.cells=500,n.subsamples=100,min.cells=10,n.cores=30)

rlist.sub <- list("JS med"=xMed,"corr med"=xMedc,"JS high"=xHi,"corr high"=xHic)

xMed <- estimateExpressionShiftMagnitudes(lapply(con$samples,conos:::getRawCountMatrix),sample.groups=sgf,cell.groups=tans$med.clean,dist='JS',n.cells=Inf,n.subsamples=1,min.cells=10,n.cores=30) 
xMedc <- estimateExpressionShiftMagnitudes(lapply(con$samples,conos:::getRawCountMatrix),sample.groups=sgf,cell.groups=tans$med.clean,dist='cor',n.cells=Inf,n.subsamples=1,min.cells=10,n.cores=30) 

xHi <- estimateExpressionShiftMagnitudes(lapply(con$samples,conos:::getRawCountMatrix),sample.groups=sgf,cell.groups=tans$high.clean,dist='JS',n.cells=Inf,n.subsamples=1,min.cells=10,n.cores=30) 
xHic <- estimateExpressionShiftMagnitudes(lapply(con$samples,conos:::getRawCountMatrix),sample.groups=sgf,cell.groups=tans$high.clean,dist='cor',n.cells=Inf,n.subsamples=1,min.cells=10,n.cores=30)
rlist.full <- list("JS med"=xMed,"corr med"=xMedc,"JS high"=xHi,"corr high"=xHic)

```


## Shifts with subsampling 
Here we subsample ~500 cells total per cell type from the whole dataset
```{r fig.height=5,fig.width=8}
rlist <- rlist.sub;
pl <- lapply(names(rlist)[c(1,2)],function(nam) { 
  ggplot(rlist[[nam]]$df,aes(x=as.factor(Type),y=value)) + 
    geom_boxplot(notch=T,outlier.shape=NA) + 
    geom_jitter(position=position_jitter(0.1), aes(color=patient),show.legend=FALSE,alpha=0.05) + 
    geom_hline(yintercept = 1,linetype=2,color='gray30') +
    #ylim(0,min(5,max(rlist[[nam]]$df$value)))+
    coord_cartesian(ylim=c(0, min(3,max(rlist[[nam]]$df$value))))+
    theme(axis.text.x=element_text(angle = 90, hjust=1), axis.text.y=element_text(angle=90, hjust=0.5)) +
    ggtitle(nam)+
    labs(x="", y="normalized distance")
})
pp <- plot_grid(plotlist=pl,nrow=1)
pdf(file='shifts.sub.med.pdf',width=8,height=5); print(pp); dev.off();
pp
```

```{r fig.height=12,fig.width=8}

pl <- lapply(names(rlist)[c(3,4)],function(nam) { 
  df <- rlist[[nam]]$df # sort cell types
  df$Type <- factor(df$Type,levels=names(sort(tapply(df$value,as.factor(df$Type),median))))
  ggplot(df,aes(x=as.factor(Type),y=value)) + 
    geom_boxplot(notch=T,outlier.shape=NA) + 
    geom_jitter(position=position_jitter(0.1), aes(color=patient),show.legend=FALSE,alpha=0.05) + 
    geom_hline(yintercept = 1,linetype=2,color='gray30') +
    #ylim(0,min(5,max(rlist[[nam]]$df$value)))+
    coord_cartesian(ylim=c(0, min(5,max(rlist[[nam]]$df$value))))+
    theme(axis.text.x=element_text(angle = 90, hjust=1), axis.text.y=element_text(angle=90, hjust=0.5)) +
    ggtitle(nam)+
    labs(x="", y="normalized distance")
})
pp <- plot_grid(plotlist=pl,nrow=2)
pdf(file='shifts.sub.high.pdf',width=8,height=12); print(pp); dev.off();
pp
```

Try better rendering
```{r fig.height=12,fig.width=8}

pl <- lapply(names(rlist)[c(3,4)],function(nam) { 
  df <- rlist[[nam]]$df # sort cell types
  df$Type <- factor(df$Type,levels=names(sort(tapply(df$value,as.factor(df$Type),median))))
  ggplot(df,aes(x=as.factor(Type),y=value,fill=Type)) + 
    geom_boxplot(notch=T,outlier.shape=NA) + scale_fill_manual(values=high.pal) +
    geom_jitter(position=position_jitter(0.1), color='gray30',show.legend=FALSE,alpha=0.05, size=0.8) + 
    geom_hline(yintercept = 1,linetype=2,color='gray30') +
    #ylim(0,min(5,max(rlist[[nam]]$df$value)))+
    coord_cartesian(ylim=c(0, min(4.5,max(rlist[[nam]]$df$value))))+
    theme_bw()+ 
    theme(axis.text.x=element_text(size=12, angle = 90, hjust=1), axis.text.y=element_text(angle=90, hjust=0.5,size=12)) + guides(fill=F) +
    ggtitle(nam)+
    labs(x="", y="normalized distance")
})
pp <- plot_grid(plotlist=pl,nrow=2)
pdf(file='shifts.sub.high.v2.pdf',width=8,height=12); print(pp); dev.off();
pp
```



```{r fig.width=8,fig.height=6}
df <- rlist[[4]]$df # sort cell types
mv <- tapply(df$value,as.factor(df$Type),median)
df <- ldf_high; df$ndem <- mv[as.character(df$Subtypes)]; df <- na.omit(df);
p2 <- ggplot(df, aes(x = reorder(Subtypes,ndem,mean), y = Layers,  color = Subtypes)) +
  geom_jitter(width = 0.35, height = 0.45, alpha = 0.4, size = 0.15, show.legend = F) +
  geom_hline(yintercept = c(1.5, 2.5, 3.5, 4.5, 5.5), linetype = 2, size = 0.6, colour = "grey") +
  scale_color_manual(values = high.pal) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 12), plot.title = element_text(hjust = 0.5, size = 18),
        axis.text.y = element_text(size = 14), axis.title = element_text(size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        text = element_text(family = "Helvetica"), axis.title.x = element_blank())
```


```{r fig.width=8,fig.height=7}
pp <- ggpubr::ggarrange(pl[[2]]+theme(axis.text.x=element_blank()),p2,ncol=1,nrow=2,heights=c(0.5,1),align = 'v')
pdf(file='shifts.sub.high.v3.pdf',height=7,width=8); print(pp); dev.off();
pp
```

Same thing for JS
```{r fig.width=8,fig.height=6}
df <- rlist[[3]]$df # sort cell types
mv <- tapply(df$value,as.factor(df$Type),median)
df <- ldf_high; df$ndem <- mv[as.character(df$Subtypes)]; df <- na.omit(df);
p2 <- ggplot(df, aes(x = reorder(Subtypes,ndem,mean), y = Layers,  color = Subtypes)) +
  geom_jitter(width = 0.35, height = 0.45, alpha = 0.4, size = 0.15, show.legend = F) +
  geom_hline(yintercept = c(1.5, 2.5, 3.5, 4.5, 5.5), linetype = 2, size = 0.6, colour = "grey") +
  scale_color_manual(values = high.pal) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 12), plot.title = element_text(hjust = 0.5, size = 18),
        axis.text.y = element_text(size = 14), axis.title = element_text(size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        text = element_text(family = "Helvetica"), axis.title.x = element_blank())
```

```{r fig.width=8,fig.height=7}
pp <- ggpubr::ggarrange(pl[[1]]+theme(axis.text.x=element_blank()),p2,ncol=1,nrow=2,heights=c(0.5,1),align = 'v')
#pdf(file='shifts.sub.high.JS.v3.pdf',height=7,width=8); print(pp); dev.off();
pp
```


```{r fig.height=5,fig.width=8}
rlist <- rlist.sub;
pl <- lapply(names(rlist)[c(1,2)],function(nam) { 
  ggplot(rlist[[nam]]$df,aes(x=as.factor(Type),y=value,fill=Type)) + 
    geom_boxplot(notch=T,outlier.shape=NA) + scale_fill_manual(values=med.pal) +
    geom_jitter(position=position_jitter(0.1), color='gray30',show.legend=FALSE,alpha=0.05, size=0.8) + 
    geom_hline(yintercept = 1,linetype=2,color='gray30') +
    #ylim(0,min(5,max(rlist[[nam]]$df$value)))+
    coord_cartesian(ylim=c(0, min(3.5,max(rlist[[nam]]$df$value))))+ 
    theme_bw() +
    theme(axis.text.x=element_text(angle = 90, hjust=1,size=12), axis.text.y=element_text(angle=90, hjust=0.5,size=12)) + guides(fill=F) +
    ggtitle(nam)+
    labs(x="", y="normalized distance")
})
pp <- plot_grid(plotlist=pl,nrow=1)
pdf(file='shifts.sub.med.pdf',width=8,height=5); print(pp); dev.off();
pp
```


```{r fig.width=8,fig.height=6}
df <- rlist[[2]]$df # sort cell types
mv <- tapply(df$value,as.factor(df$Type),median)
df <- ldf_med; df$ndem <- mv[as.character(df$Subtypes)]; df <- na.omit(df);
p2 <- ggplot(df, aes(x = reorder(Subtypes,ndem,mean), y = Layers,  color = Subtypes)) +
  geom_jitter(width = 0.35, height = 0.45, alpha = 0.4, size = 0.15, show.legend = F) +
  geom_hline(yintercept = c(1.5, 2.5, 3.5, 4.5, 5.5), linetype = 2, size = 0.6, colour = "grey") +
  scale_color_manual(values = med.pal) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 12), plot.title = element_text(hjust = 0.5, size = 18),
        axis.text.y = element_text(size = 14), axis.title = element_text(size = 12),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        text = element_text(family = "Helvetica"), axis.title.x = element_blank())
```


```{r fig.width=4,fig.height=6}
pp <- ggpubr::ggarrange(pl[[2]]+theme(axis.text.x=element_blank())+ggtitle(""),p2,ncol=1,nrow=2,heights=c(0.7,1),align = 'v')
pdf(file='shifts.sub.med.v3.pdf',height=6,width=4); print(pp); dev.off();
pp
```


### Normalizing to the median intra-control distance
```{r}
cm <- lapply(con$samples,conos:::getRawCountMatrix,transpose=T)
xMed <- estimateExpressionShiftMagnitudes(cm,sample.groups=sgf,cell.groups=tans$med.clean,dist='JS',n.cells=500,n.subsamples=100,min.cells=10,n.cores=30,transposed.matrices = TRUE, ctdml = rlist.sub[['JS med']]$ctdml) 
xMedc <- estimateExpressionShiftMagnitudes(cm,sample.groups=sgf,cell.groups=tans$med.clean,dist='cor',n.cells=500,n.subsamples=100,min.cells=10,n.cores=30,transposed.matrices = TRUE, ctdml = rlist.sub[['corr med']]$ctdml) 

xHi <- estimateExpressionShiftMagnitudes(cm,sample.groups=sgf,cell.groups=tans$high.clean,dist='JS',n.cells=500,n.subsamples=100,min.cells=10,n.cores=30,transposed.matrices = TRUE, ctdml = rlist.sub[['JS high']]$ctdml) 
xHic <- estimateExpressionShiftMagnitudes(cm,sample.groups=sgf,cell.groups=tans$high.clean,dist='cor',n.cells=500,n.subsamples=100,min.cells=10,n.cores=30,transposed.matrices = TRUE, ctdml = rlist.sub[['corr high']]$ctdml)

rlist.sub.maxnorm <- list("JS med"=xMed,"corr med"=xMedc,"JS high"=xHi,"corr high"=xHic)
```

```{r fig.height=5,fig.width=8}
rlist <- rlist.sub.maxnorm;
pl <- lapply(names(rlist)[c(1,2)],function(nam) { 
  ggplot(rlist[[nam]]$df,aes(x=as.factor(Type),y=value)) + 
    geom_boxplot(notch=T,outlier.shape=NA) + 
    geom_jitter(position=position_jitter(0.1), aes(color=patient),show.legend=FALSE,alpha=0.1) + 
    geom_hline(yintercept = 1,linetype=2,color='gray80') +
    #ylim(0,min(5,max(rlist[[nam]]$df$value)))+
    coord_cartesian(ylim=c(0, min(5,max(rlist[[nam]]$df$value))))+
    theme(axis.text.x=element_text(angle = 90, hjust=1), axis.text.y=element_text(angle=90, hjust=0.5)) +
    ggtitle(nam)+
    labs(x="", y="normalized distance")
})
plot_grid(plotlist=pl,nrow=1)
```

```{r fig.height=12,fig.width=8}

pl <- lapply(names(rlist)[c(3,4)],function(nam) { 
  df <- rlist[[nam]]$df # sort cell types
  df$Type <- factor(df$Type,levels=names(sort(tapply(df$value,as.factor(df$Type),median))))
  ggplot(df,aes(x=as.factor(Type),y=value)) + 
    geom_boxplot(notch=T,outlier.shape=NA) + 
    geom_jitter(position=position_jitter(0.1), aes(color=patient),show.legend=FALSE,alpha=0.1) + 
    geom_hline(yintercept = 1,linetype=2,color='gray80') +
    #ylim(0,min(5,max(rlist[[nam]]$df$value)))+
    coord_cartesian(ylim=c(0, min(5,max(rlist[[nam]]$df$value))))+
    theme(axis.text.x=element_text(angle = 90, hjust=1), axis.text.y=element_text(angle=90, hjust=0.5)) +
    ggtitle(nam)+
    labs(x="", y="normalized distance")
})
plot_grid(plotlist=pl,nrow=2)
```


### No subsampling version
Here we use all cells. This may change the relative contributions of different datasets.

```{r fig.height=5,fig.width=8}
rlist <- rlist.full;
pl <- lapply(names(rlist)[c(1,2)],function(nam) { 
  ggplot(rlist[[nam]]$df,aes(x=as.factor(Type),y=value)) + 
    geom_boxplot(notch=T,outlier.shape=NA) + 
    geom_jitter(position=position_jitter(0.1), aes(color=patient),show.legend=FALSE,alpha=0.1) + 
    geom_hline(yintercept = 1,linetype=2,color='gray80') +
    #ylim(0,min(5,max(rlist[[nam]]$df$value)))+
    coord_cartesian(ylim=c(0, min(5,max(rlist[[nam]]$df$value))))+
    theme(axis.text.x=element_text(angle = 90, hjust=1), axis.text.y=element_text(angle=90, hjust=0.5)) +
    ggtitle(nam)+
    labs(x="", y="normalized distance")
})
plot_grid(plotlist=pl,nrow=1)
```

```{r fig.height=12,fig.width=8}

pl <- lapply(names(rlist)[c(3,4)],function(nam) { 
  df <- rlist[[nam]]$df # sort cell types
  df$Type <- factor(df$Type,levels=names(sort(tapply(df$value,as.factor(df$Type),median))))
  ggplot(df,aes(x=as.factor(Type),y=value)) + 
    geom_boxplot(notch=T,outlier.shape=NA) + 
    geom_jitter(position=position_jitter(0.1), aes(color=patient),show.legend=FALSE,alpha=0.1) + 
    geom_hline(yintercept = 1,linetype=2,color='gray80') +
    #ylim(0,min(5,max(rlist[[nam]]$df$value)))+
    coord_cartesian(ylim=c(0, min(5,max(rlist[[nam]]$df$value))))+
    theme(axis.text.x=element_text(angle = 90, hjust=1), axis.text.y=element_text(angle=90, hjust=0.5)) +
    ggtitle(nam)+
    labs(x="", y="normalized distance")
})
plot_grid(plotlist=pl,nrow=2)
```

```{r}
df <- rlist[[4]]$df
#df <- old.xHi$df
df$cell <- df$Type
x <- tapply(df$value,df$cell,median)
cf <- tans$high.clean
cct <- table(cf,con$getDatasetPerCell()[names(cf)])
odf <- data.frame(cell=names(x),size=rowSums(cct)[names(x)],md=x)
p1 <- ggplot(odf,aes(size,md,color=cell,label=cell)) + geom_point() + geom_text_repel() + guides(color=F) + xlab('subsampled size')
p1
```

## Shifts along a common direction

```{r}
source("common.shifts.R");

xl.med <- commonExpressionShiftMagnitudes(count.matrices = lapply(con$samples,conos:::getRawCountMatrix,transpose=T), 
                                          transposed.matrices = TRUE, sample.groups=sgf, cell.groups=tans$med.clean,
                                          n.cells=1000, n.randomizations=50,n.subsamples=60,n.cores=30)

xl.med.av <- lapply(sn(names(xl.med[[1]])),function(n) colMeans(do.call(rbind,lapply(xl.med,function(x) x[[n]]))))

xlA.med <- commonExpressionShiftMagnitudes(count.matrices = lapply(con$samples,conos:::getRawCountMatrix,transpose=T), 
                                           transposed.matrices = TRUE, sample.groups=sgf, cell.groups=tans$med.clean,
                                           n.cells=Inf, n.randomizations=100,n.subsamples=50,n.cores=1)
  

xl.high <- commonExpressionShiftMagnitudes(count.matrices = lapply(con$samples,conos:::getRawCountMatrix,transpose=T), 
                                          transposed.matrices = TRUE, sample.groups=sgf, cell.groups=tans$high.clean,
                                          n.cells=1000, n.randomizations=50,n.subsamples=60,n.cores=30)

xl.high.av <- lapply(sn(names(xl.high[[1]])),function(n) colMeans(do.call(rbind,lapply(xl.high,function(x) x[[n]]))))
lapply(xl.high.av,mean) %>% unlist %>% sort

xlA.high <- commonExpressionShiftMagnitudes(count.matrices = lapply(con$samples,conos:::getRawCountMatrix,transpose=T), 
                                           transposed.matrices = TRUE, sample.groups=sgf, cell.groups=tans$high.clean,
                                           n.cells=Inf, n.randomizations=100,n.subsamples=50,n.cores=1)
```


```{r fig.height=12,fig.width=8}
t.plot.common.expression.shifts <- function(res, show.subsampling.variability=FALSE,jitter.alpha=0.1) { 
  cn <- setNames(names(res[[1]]),names(res[[1]]))
  if(show.subsampling.variability) { # average across patient pairs
    if(length(res)<2) stop('the result has only one subsample; please set show.sampling.variability=FALSE')
    df <- do.call(rbind,lapply(res,function(d) data.frame(val=unlist(lapply(d,mean)),cell=names(d))))
  } else { # average across subsampling rounds
    df <- do.call(rbind,lapply(cn,function(n) data.frame(val=colMeans(do.call(rbind,lapply(res,function(x) x[[n]]))),cell=n)))
  }
  av <- sort(tapply(df$val,df$cell,median))
  ggplot(df,aes(x=factor(cell,levels=names(av)),y=val))+
    geom_boxplot(notch=T,outlier.shape=NA) + 
    geom_jitter(position=position_jitter(0.1),show.legend=FALSE,alpha=jitter.alpha) + 
    geom_hline(yintercept = 1,linetype=2,color='red')+
    theme(axis.text.x=element_text(angle = 90, hjust=1), axis.text.y=element_text(angle=90, hjust=0.5))+
    labs(x="", y="normalized distance (common)")
}

t.plot.common.expression.shifts.mean <- function(res, show.subsampling.variability=FALSE,jitter.alpha=0.1,pal=NULL) { 
  cn <- setNames(names(res[[1]]),names(res[[1]]))
  if(show.subsampling.variability) { # average across patient pairs
    if(length(res)<2) stop('the result has only one subsample; please set show.sampling.variability=FALSE')
    df <- do.call(rbind,lapply(res,function(d) data.frame(val=unlist(lapply(d,mean)),cell=names(d))))
  } else { # average across subsampling rounds
    df <- do.call(rbind,lapply(cn,function(n) data.frame(val=colMeans(do.call(rbind,lapply(res,function(x) x[[n]]))),cell=n)))
  }
  df <- data.frame(cell=levels(df$cell),mean=tapply(df$val,df$cell,mean),se=tapply(df$val,df$cell,function(x) sd(x)/sqrt(length(x))),stringsAsFactors=F)
  df <- df[order(df$mean,decreasing=F),]
  df$cell <- factor(df$cell,levels=df$cell)
  
  p <- ggplot(df,aes(x=cell,y=mean,fill=cell))+
    geom_bar(stat='identity') + 
    geom_errorbar(aes(ymin=mean-se*1.96, ymax=mean+se*1.96),width=0.2)+
    geom_jitter(position=position_jitter(0.1),show.legend=FALSE,alpha=jitter.alpha) + 
    geom_hline(yintercept = 1,linetype=2,color='gray50')+
    theme_bw() +
    theme(axis.text.x=element_text(angle = 90, hjust=1, size=12), axis.text.y=element_text(angle=90, hjust=0.5, size=12))+ guides(fill=FALSE)+
    theme(legend.position = "none")+
    labs(x="", y="normalized distance (common)")
  if(!is.null(pal)) {
    p <- p+ scale_fill_manual(values=pal)
  }
  p
}

```



Here we show the result, using boxplots to show the uncertainty in the mean (across subsamplings)
```{r fig.height=6,fig.width=7}
t.plot.common.expression.shifts(xl.high,show.subsampling.variability = TRUE,jitter.alpha=0.05)
```

We can show inter-patient variation instead:

```{r fig.height=6,fig.width=7}
t.plot.common.expression.shifts(xl.high,show.subsampling.variability = FALSE,jitter.alpha=0.05)
```

It's probably a bit more appropriate to show the means (instead of the medians above):
```{r fig.height=5,fig.width=8}
p <- t.plot.common.expression.shifts.mean(xl.high,show.subsampling.variability = F,jitter.alpha=0.05,pal=high.pal) + coord_cartesian(ylim=c(0.5,1.7))
pdf(file='shifts.common.high.pdf',width=8,height=5); print(p); dev.off();
p
```

```{r fig.width=8,fig.height=6}
res <- xl.high
cn <- setNames(names(res[[1]]),names(res[[1]]))
df <- do.call(rbind,lapply(cn,function(n) data.frame(val=colMeans(do.call(rbind,lapply(res,function(x) x[[n]]))),cell=n)))
  
df <- data.frame(cell=levels(df$cell),mean=tapply(df$val,df$cell,mean),se=tapply(df$val,df$cell,function(x) sd(x)/sqrt(length(x))),stringsAsFactors=F)
xdf <- df
  
df <- ldf_high; df$ndem <- xdf$mean[match(as.character(df$Subtypes),xdf$cell)]; df <- na.omit(df);
p2 <- ggplot(df, aes(x = reorder(Subtypes,ndem,mean), y = Layers,  color = Subtypes)) +
  geom_jitter(width = 0.35, height = 0.45, alpha = 0.4, size = 0.15, show.legend = F) +
  geom_hline(yintercept = c(1.5, 2.5, 3.5, 4.5, 5.5), linetype = 2, size = 0.6, colour = "grey") +
  scale_color_manual(values = high.pal) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 12), plot.title = element_text(hjust = 0.5, size = 18),
        axis.text.y = element_text(size = 14), axis.title = element_text(size = 14),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        text = element_text(family = "Helvetica"), axis.title.x = element_blank())
```

```{r fig.width=8,fig.height=7}
pp <- ggpubr::ggarrange(p+theme(axis.text.x=element_blank()),p2,ncol=1,nrow=2,heights=c(0.45,1),align = 'v')
pdf(file='shifts.common.high.comb.pdf',height=7,width=8); print(pp); dev.off();
pp
```






## A version without subsampling
```{r fig.height=6,fig.width=7}
t.plot.common.expression.shifts(xlA.high,show.subsampling.variability = FALSE,jitter.alpha=0.05)
```





Same plots for the medium resolution
```{r fig.height=4,fig.width=5}
t.plot.common.expression.shifts(xl.med,show.subsampling.variability = TRUE,jitter.alpha=0.05) + ggtitle("subsampling var")
t.plot.common.expression.shifts(xl.med,show.subsampling.variability = F,jitter.alpha=0.05) + ggtitle("patient var; with subsampling")
p <- t.plot.common.expression.shifts.mean(xl.med,show.subsampling.variability = F,jitter.alpha=0.05,pal=med.pal) + coord_cartesian(ylim=c(0.5,1.4)) + ggtitle("patient var; with subsampling; mean")
pdf(file='shifts.common.med.pdf',width=5,height=4); print(p); dev.off();
p
t.plot.common.expression.shifts(xlA.med,show.subsampling.variability = F,jitter.alpha=0.05) + ggtitle("patient var; no subsampling")
```

```{r fig.width=8,fig.height=6}
res <- xl.med
cn <- setNames(names(res[[1]]),names(res[[1]]))
df <- do.call(rbind,lapply(cn,function(n) data.frame(val=colMeans(do.call(rbind,lapply(res,function(x) x[[n]]))),cell=n)))
  
df <- data.frame(cell=levels(df$cell),mean=tapply(df$val,df$cell,mean),se=tapply(df$val,df$cell,function(x) sd(x)/sqrt(length(x))),stringsAsFactors=F)
xdf <- df
  
df <- ldf_med; df$ndem <- xdf$mean[match(as.character(df$Subtypes),xdf$cell)]; df <- na.omit(df);
p2 <- ggplot(df, aes(x = reorder(Subtypes,ndem,mean), y = Layers,  color = Subtypes)) +
  geom_jitter(width = 0.35, height = 0.45, alpha = 0.4, size = 0.15, show.legend = F) +
  geom_hline(yintercept = c(1.5, 2.5, 3.5, 4.5, 5.5), linetype = 2, size = 0.6, colour = "grey") +
  scale_color_manual(values = med.pal) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 12), plot.title = element_text(hjust = 0.5, size = 18),
        axis.text.y = element_text(size = 14), axis.title = element_text(size = 14),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        text = element_text(family = "Helvetica"), axis.title.x = element_blank())
```

```{r fig.width=4,fig.height=6}
pp <- ggpubr::ggarrange(p+theme(axis.text.x=element_blank()),p2,ncol=1,nrow=2,heights=c(0.45,1),align = 'v')
pdf(file='shifts.common.med.comb.pdf',height=6,width=4); print(pp); dev.off();
pp
```

```{r}
df <- rlist[[4]]$df
#df <- old.xHi$df
df$cell <- df$Type
x <- tapply(df$value,df$cell,median)
cf <- tans$high.clean
cct <- table(cf,con$getDatasetPerCell()[names(cf)])
odf <- data.frame(cell=names(x),size=rowSums(cct)[names(x)],md=x)
p1 <- ggplot(odf,aes(size,md,color=cell,label=cell)) + geom_point() + geom_text_repel() + guides(color=F) + xlab('subsampled size')
p1
```

# Differential expression tests

## DE tests with a limited number of cells
```{r}
de.high  <- getPerCellTypeDE(con, groups=tans$high.clean, sample.groups = samplegroups, ref.level='control', n.cores=30,max.cell.count=80,test='LRT')
de.high <- de.high[!is.na(de.high)]
de.med  <- getPerCellTypeDE(con, groups=tans$med.clean, sample.groups = samplegroups, ref.level='control', n.cores=30,max.cell.count=80,test='LRT')
de.med <- de.med[!is.na(de.med)]
del.fixedL <- list(high=de.high,med=de.med)
```

```{r}
de.high  <- getPerCellTypeDE(con, groups=tans$high.clean, sample.groups = samplegroups, ref.level='control', n.cores=30,max.cell.count=80,test='Wald')
de.high <- de.high[!is.na(de.high)]
de.med  <- getPerCellTypeDE(con, groups=tans$med.clean, sample.groups = samplegroups, ref.level='control', n.cores=30,max.cell.count=80,test='Wald')
de.med <- de.med[!is.na(de.med)]
del.fixedW <- list(high=de.high,med=de.med)
```

```{r}
saveRDS(del.fixedW,file='del.fixedW.rds')
```


```{r fig.width=8,fig.height=4.5}
x <- lapply(del.fixedW$high,function(x) sum(na.omit(x$res$pvalue<1e-3))) %>% unlist %>% sort
p <- ggplot(data.frame(cell=names(x),nde=x),aes(x=reorder(cell,nde),y=nde,fill=cell)) + geom_bar(stat="identity")+ theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=12),axis.title.x = element_blank()) +ylab("number of DE genes") + scale_fill_manual(values=high.pal) + guides(fill=F)
pdf(file='nDE.high.pdf',width=8,height=5); print(p); dev.off();
p
```

```{r fig.width=8,fig.height=6}
df <- ldf_high; df$ndem <- x[as.character(df$Subtypes)]; df <- na.omit(df);
p2 <- ggplot(df, aes(x = reorder(Subtypes,ndem,mean), y = Layers,  color = Subtypes)) +
  geom_jitter(width = 0.35, height = 0.45, alpha = 0.4, size = 0.15, show.legend = F) +
  geom_hline(yintercept = c(1.5, 2.5, 3.5, 4.5, 5.5), linetype = 2, size = 0.6, colour = "grey") +
  scale_color_manual(values = high.pal) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 12), plot.title = element_text(hjust = 0.5, size = 18),
        axis.text.y = element_text(size = 14), axis.title = element_text(size = 14),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        text = element_text(family = "Helvetica"), axis.title.x = element_blank())
```

```{r fig.width=8,fig.height=6}
pp <- ggpubr::ggarrange(p+theme(axis.text.x=element_blank()),p2,ncol=1,nrow=2,heights=c(0.3,1),align = 'v')
pdf(file='ngenes.high.comb.pdf',height=6,width=8); print(pp); dev.off();
pp
```

LRT test:
```{r fig.width=8,fig.height=4.5}
x <- lapply(del.fixedL$high,function(x) sum(na.omit(x$res$pvalue<1e-3))) %>% unlist %>% sort
p <- ggplot(data.frame(cell=names(x),nde=x),aes(x=reorder(cell,nde),y=nde,fill=cell)) + geom_bar(stat="identity")+ theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=12),axis.title.x = element_blank()) +ylab("number of DE genes") + scale_fill_manual(values=high.pal) + guides(fill=F)
#pdf(file='nDE_L.high.pdf',width=8,height=5); print(p); dev.off();
p
```


```{r fig.width=8,fig.height=6}
df <- ldf_high; df$ndem <- x[as.character(df$Subtypes)]; df <- na.omit(df);
p2 <- ggplot(df, aes(x = reorder(Subtypes,ndem,mean), y = Layers,  color = Subtypes)) +
  geom_jitter(width = 0.35, height = 0.45, alpha = 0.4, size = 0.15, show.legend = F) +
  geom_hline(yintercept = c(1.5, 2.5, 3.5, 4.5, 5.5), linetype = 2, size = 0.6, colour = "grey") +
  scale_color_manual(values = high.pal) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 12), plot.title = element_text(hjust = 0.5, size = 18),
        axis.text.y = element_text(size = 12), axis.title = element_text(size = 14),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        text = element_text(family = "Helvetica"), axis.title.x = element_blank())
```

```{r fig.width=8,fig.height=6}
pp <- ggpubr::ggarrange(p+theme(axis.text.x=element_blank()),p2,ncol=1,nrow=2,heights=c(0.3,1),align = 'v')
pp
```

```{r}
cf <- tans$high.clean
cct <- table(cf,con$getDatasetPerCell()[names(cf)])
odf <- data.frame(cell=names(x),size=rowSums(cct)[names(x)],md=x)
p1 <- ggplot(odf,aes(size,md,color=cell,label=cell)) + geom_point() + geom_text_repel() + guides(color=F) + xlab('number of cells in a dataset') +ylab("number of DE genes")
p1
```




## Number of DE genes with inter-individual bootstrap subsampling

```{r}
n.bootstraps <- 30; 
xb.med <- mclapply(1:n.bootstraps, function(i) {
  ssg <- lapply(samplegroups,function(x) sample(x,length(x),replace=T))
  de.med  <- getPerCellTypeDE(con, groups=tans$med.clean, sample.groups = ssg, ref.level='control', n.cores=1,max.cell.count=80,test='Wald')
  de.med <- de.med[!is.na(de.med)]
  x <- lapply(de.med,function(x) sum(na.omit(x$res$pvalue<1e-3))) %>% unlist
  data.frame(cell=names(x),nde=x)
},mc.cores=30)

xb.high <- mclapply(1:n.bootstraps, function(i) {
  ssg <- lapply(samplegroups,function(x) sample(x,length(x),replace=T))
  de.med  <- getPerCellTypeDE(con, groups=tans$high.clean, sample.groups = ssg, ref.level='control', n.cores=1,max.cell.count=80,test='Wald')
  de.med <- de.med[!is.na(de.med)]
  x <- lapply(de.med,function(x) sum(na.omit(x$res$pvalue<1e-3))) %>% unlist
  data.frame(cell=names(x),nde=x)
},mc.cores=10)

xb.highL <- mclapply(1:n.bootstraps, function(i) {
  ssg <- lapply(samplegroups,function(x) sample(x,length(x),replace=T))
  de.med  <- getPerCellTypeDE(con, groups=tans$high.clean, sample.groups = ssg, ref.level='control', n.cores=1,max.cell.count=80,test='LRT')
  de.med <- de.med[!is.na(de.med)]
  #cat('.')
  x <- lapply(de.med,function(x) sum(na.omit(x$res$pvalue<1e-3))) %>% unlist
  data.frame(cell=names(x),nde=x)
},mc.cores=10)

```


```{r fig.width=8,fig.height=5}
#x <- lapply(del.fixedW$high,function(x) sum(na.omit(x$res$pvalue<1e-3))) %>% unlist %>% sort
x <- do.call(rbind,xb.high)
x <- do.call(rbind,tapply(1:nrow(x),x$cell,function(ii) data.frame(cell=x$cell[ii[1]],nde=mean(x$nde[ii]),sd=sd(x$nde[ii]))))
p <- ggplot(x,aes(x=reorder(cell,nde),y=nde)) + geom_bar(stat="identity",color='gray50')+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),axis.title.x = element_blank()) +ylab("number of DE genes") +  geom_errorbar( aes(x=reorder(cell,nde), ymin=nde-sd, ymax=nde+sd), width=0.4, colour="black", alpha=0.9, size=1.5);
#pdf(file='nDE.high.pdf',width=8,height=5); print(p); dev.off();
p
```

```{r fig.width=8,fig.height=5}
#x <- lapply(del.fixedW$high,function(x) sum(na.omit(x$res$pvalue<1e-3))) %>% unlist %>% sort
x <- do.call(rbind,xb.high)
x <- do.call(rbind,lapply(xb.high,function(x) { x$rank <- rank(x$nde); x$nde <- x$nde/sum(x$nde); x}))
#x <- do.call(rbind,tapply(1:nrow(x),x$cell,function(ii) data.frame(cell=x$cell[ii[1]],nde=mean(x$nde[ii]),sd=sd(x$nde[ii]))))
#p <- ggplot(x,aes(x=reorder(cell,nde),y=nde)) + geom_boxplot()+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),axis.title.x = element_blank()) +ylab("number of DE genes") #+  geom_errorbar( aes(x=reorder(cell,nde), ymin=nde-sd, ymax=nde+sd), width=0.4, colour="black", alpha=0.9, size=1.5);
#pdf(file='nDE.high.pdf',width=8,height=5); print(p); dev.off();

p <- ggplot(x,aes(x=reorder(cell,nde,median),y=nde,fill=cell)) + 
    geom_boxplot(notch=T,outlier.shape=NA) + 
    geom_jitter(position=position_jitter(0.1), show.legend=FALSE,alpha=0.1) + 
    coord_cartesian(ylim=c(0, 0.08))+
    #coord_cartesian(ylim=c(0, 1e3))+
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1,size=12),axis.title.x = element_blank()) +ylab("fraction of all DE genes") + scale_fill_manual(values=high.pal) + guides(fill=F)

pdf(file='nDE_box.high.pdf',width=8,height=5); print(p); dev.off();
p
```


Combine with the layer distribution plot
```{r fig.width=8,fig.height=6}
mv <- tapply(x$nde,x$cell,median);
df <- ldf_high; df$ndem <- mv[as.character(df$Subtypes)]; df <- na.omit(df);
p2 <- ggplot(df, aes(x = reorder(Subtypes,ndem,mean), y = Layers,  color = Subtypes)) +
  geom_jitter(width = 0.35, height = 0.45, alpha = 0.4, size = 0.15, show.legend = F) +
  geom_hline(yintercept = c(1.5, 2.5, 3.5, 4.5, 5.5), linetype = 2, size = 0.6, colour = "grey") +
  scale_color_manual(values = high.pal) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 12), plot.title = element_text(hjust = 0.5, size = 18),
        axis.text.y = element_text(size = 14), axis.title = element_text(size = 14),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        text = element_text(family = "Helvetica"), axis.title.x = element_blank())
p2
```

```{r fig.width=8,fig.height=8}
pp <- ggpubr::ggarrange(p+theme(axis.text.x=element_blank()),p2,ncol=1,nrow=2,heights=c(0.5,1))
pdf(file='fgenes.high.comb.pdf',height=8,width=8); print(pp); dev.off();
pp
```



## General DE tests

```{r}
de.high  <- getPerCellTypeDE(con, groups=tans$high.clean, sample.groups = samplegroups, ref.level='control', n.cores=30,test='LRT')
de.med  <- getPerCellTypeDE(con, groups=tans$med.clean, sample.groups = samplegroups, ref.level='control', n.cores=30,test='LRT')
saveRDS(de.high,file='de.high.rds')
saveRDS(de.med,file='de.med.rds')
del <- list(high=de.high,med=de.med)
```

```{r}
de.high  <- getPerCellTypeDE(con, groups=tans$high.clean, sample.groups = samplegroups, ref.level='control', n.cores=30,test='Wald')
de.med  <- getPerCellTypeDE(con, groups=tans$med.clean, sample.groups = samplegroups, ref.level='control', n.cores=30,test='Wald')
saveRDS(de.high,file='de.high.wald.rds')
saveRDS(de.med,file='de.med.wald.rds')
delW <- list(high=de.high,med=de.med)
```

Clean up excessive genes, recalculate padj
```{r}
sort(unlist(lapply(del`W`$high[!is.na(delW$high)],function(d) sum(na.omit(d$res$padj<=0.05)))))
```
```{r}
m <- conos:::rawMatricesWithCommonGenes(con)
n.cells.per.gene <- rowSums(do.call(cbind,lapply(m,function(x) Matrix::colSums(x>0))))
valid.genes <- names(n.cells.per.gene)[n.cells.per.gene>200]
length(valid.genes)
```

Clean up diff. expression results, update padj
```{r}
delWclean <- lapply(delW,function(x) {
  lapply(x[!is.na(x)],function(r) {
    r$res <- r$res[rownames(r$res) %in% valid.genes,]
    r$res$padj <- p.adjust(r$res$pvalue,method='BH')
    r
  })
})
```

```{r}
sort(unlist(lapply(delWclean$high[!is.na(delWclean$high)],function(d) sum(na.omit(d$res$padj<=0.05)))))
```

# GO overviews
```{r}
library(tibble)
library(dplyr)
library(cowplot)
library(readr)
library(pheatmap)
library(reshape2)
library(clusterProfiler)
library(DOSE)
library(org.Hs.eg.db)
library(enrichplot)
library(pbapply)
require(ComplexHeatmap)
require(circlize)
library(magrittr)
```


Prepare GO categories ... 
```{r}
 go_datas <- c("BP", "CC", "MF") %>% setNames(., .) %>%
   pblapply(function(n) clusterProfiler:::get_GO_data(org.Hs.eg.db, n, "ENTREZID") %>%
              as.list() %>% as.environment()) # otherwise it pass reference to the environment content
```

Run enrichment tests

```{r}
enrichGOOpt <- function (gene, OrgDB, goData, keyType = "ENTREZID", ont = "MF", pvalueCutoff = 0.05,
                         pAdjustMethod = "BH", universe=NULL, qvalueCutoff = 0.2, minGSSize = 10,
                         maxGSSize = 500, readable = FALSE, pool = FALSE) {
  ont %<>% toupper %>% match.arg(c("BP", "CC", "MF"))

  res <- clusterProfiler:::enricher_internal(gene, pvalueCutoff = pvalueCutoff,
                                             pAdjustMethod = pAdjustMethod, universe = universe,
                                             qvalueCutoff = qvalueCutoff, minGSSize = minGSSize,
                                             maxGSSize = maxGSSize, USER_DATA = goData)
  if (is.null(res))
    return(res)

  res@keytype <- keyType
  res@organism <- clusterProfiler:::get_organism(OrgDB)
  if (readable) {
    res <- DOSE::setReadable(res, OrgDB)
  }
  res@ontology <- ont

  return(res)
}

distanceBetweenTerms <- function(go.df) {
  genes.per.go <- sapply(go.df$geneID, strsplit, "/") %>% setNames(go.df$Description)
  all.go.genes <- unique(unlist(genes.per.go))
  all.gos <- unique(go.df$Description)

  genes.per.go.mat <- matrix(0, length(all.go.genes), length(all.gos)) %>%
    `colnames<-`(all.gos) %>% `rownames<-`(all.go.genes)

  for (i in 1:length(genes.per.go)) {
    genes.per.go.mat[genes.per.go[[i]], go.df$Description[[i]]] <- 1
  }

  return(dist(t(genes.per.go.mat), method="binary"))
}

```


```{r}
calculate.gos <- function(de,n.top.genes=300,n.cores=1) {
  de <- de[unlist(lapply(de,is.list))]
  
  # add Z scores
  de <- lapply(de,function(d) {
    res.table <- d$res;
    res.table$Z <- -qnorm(res.table$pval/2)
    res.table$Z[is.na(res.table$Z)] <- 0
    res.table$Za <- -qnorm(res.table$padj/2)
    res.table$Za[is.na(res.table$Za)] <- 0
    res.table$Z <- res.table$Z  * sign(res.table$log2FoldChange)
    res.table$Za <- res.table$Za  * sign(res.table$log2FoldChange)
    d$res <- res.table;
    d
  })
  
  
  gns <- list(down=lapply(de,function(x) rownames(x$res)[order(x$res$Z,decreasing=F)[1:n.top.genes]]),
              up=lapply(de,function(x) rownames(x$res)[order(x$res$Z,decreasing=T)[1:n.top.genes]]),
              all=list(all=unique(unlist(lapply(de,function(x) rownames(x$res))))))
  
  gns.entrez <- lapply(gns,function(x) lapply(x, bitr, 'SYMBOL', 'ENTREZID', org.Hs.eg.db) %>% lapply(`[[`, "ENTREZID"))
  
  gos <- lapply(gns.entrez[c('up','down')],function(gns) {
    lapply(gns,enrichGOOpt,universe=gns.entrez$all$all, ont='BP', goData=go_datas[['BP']], readable=T, OrgDB=org.Hs.eg.db)# %>% lapply(function(x) x@result)
  })
  
}

gos.cluster <- function(gos,n.clusters=20,max.pval=0.05) {
  gos_filt <- lapply(gos,function(x) filter(x@result,p.adjust<max.pval))
  gos_joint <- do.call(rbind,gos_filt)
  
  gos_joint <- gos_filt %>% .[sapply(., nrow) > 0] %>% names() %>% setNames(., .) %>% lapply(function(n) cbind(gos_filt[[n]],Type=n)) %>% Reduce(rbind,.)
  go_dist <- distanceBetweenTerms(gos_joint)
  clusts <- hclust(go_dist,method='ward.D2') %>% cutree(n.clusters)
  gos_per_clust <- split(names(clusts), clusts)
  ngos_per_clust <- sapply(gos_per_clust, length)
  #table(clusts)
  
  gos_per_clust <- split(names(clusts), clusts)
  gos_joint %<>% mutate(GOClust=clusts[Description])
  name_per_clust <- gos_joint %>% group_by(GOClust, Description) %>% summarise(pvalue=exp(mean(log(pvalue)))) %>% 
    split(.$GOClust) %>% sapply(function(df) df$Description[which.min(df$pvalue)])
  gos_joint %<>% mutate(GOClustName=name_per_clust[as.character(GOClust)])
  
  # cluster summary
  go_bp_summ_df <- gos_joint %>% group_by(Type, GOClustName) %>% 
    summarise(p.adjust=min(p.adjust)) %>% ungroup() %>% mutate(p.adjust=-log10(p.adjust)) %>% 
    tidyr::spread(Type, p.adjust) %>% as.data.frame() %>% set_rownames(.$GOClustName) %>% .[, 2:ncol(.)] #%>% .[, type_order[type_order %in% colnames(.)]]
  go_bp_summ_df[is.na(go_bp_summ_df)] <- 0
  
  return(list(joint=gos_joint,clusters=clusts,summary=go_bp_summ_df))
}

```


Calculate enrichments
```{r}
goslL <- lapply(del,calculate.gos,n.top.genes=500)
```

```{r}
goslW <- lapply(delW,calculate.gos,n.top.genes=500)
```

Calculate and plot clusters:
```{r}
cols <- list(up=colorRamp2(c(0, 6), c("grey98", "red")),down=colorRamp2(c(0, 6), c("grey98", "blue")))
n.clusters <- 20; max.pval <- 0.05;
```

### High
```{r}
cx <- lapply(goslW$high,gos.cluster,n.clusters=n.clusters,max.pval=max.pval)
```

```{r fig.width=8,fig.height=7}
mu <- Heatmap(as.matrix(cx$up$summary),col=cols$up,border=T,show_row_dend=F,show_column_dend=F, heatmap_legend_param = list(title = 'Z score'), row_names_max_width = unit(8, "cm"),row_names_gp = gpar(fontsize = 10),)
md <- Heatmap(as.matrix(cx$down$summary),col=cols$down,border=T,show_row_dend=F,show_column_dend=F, heatmap_legend_param = list(title = 'Z score'), row_names_max_width = unit(8, "cm"),row_names_gp = gpar(fontsize = 10))
pdf(file='de.high.GO.up.pdf',width=7,height=6); draw(mu, heatmap_legend_side = "left"); dev.off();
pdf(file='de.high.GO.down.pdf',width=7,height=6); draw(md, heatmap_legend_side = "left"); dev.off();
mu; md;
```


```{r}
cx <- lapply(goslW$med,gos.cluster,n.clusters=9,max.pval=0.1)
```

```{r fig.width=8,fig.height=5}
mu <- Heatmap(as.matrix(cx$up$summary),col=cols$up,border=T,show_row_dend=F,show_column_dend=F, heatmap_legend_param = list(title = 'Z score'), row_names_max_width = unit(8, "cm"),row_names_gp = gpar(fontsize = 10),)
md <- Heatmap(as.matrix(cx$down$summary),col=cols$down,border=T,show_row_dend=F,show_column_dend=F, heatmap_legend_param = list(title = 'Z score'), row_names_max_width = unit(8, "cm"),row_names_gp = gpar(fontsize = 10))
pdf(file='de.med.GO.up.pdf',width=7,height=4); draw(mu, heatmap_legend_side = "left"); dev.off();
pdf(file='de.med.GO.down.pdf',width=7,height=4); draw(md, heatmap_legend_side = "left"); dev.off();
mu; md;
```


