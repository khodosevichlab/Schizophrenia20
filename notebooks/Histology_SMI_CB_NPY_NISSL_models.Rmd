---
output:
  word_document: default
  html_document: default
---
# **Analysis of CB, NPY, SMI, Nissl densities in 6 SCH vs 6 CTR**
### *Data frame:*
```{r, echo=FALSE, message=FALSE}
library(multcomp)
library(lme4)
library(nlme)
library(ggthemes)
library(ggplot2)
sumd2 <- read.table("6sch6ctrlayerwise.csv", header=TRUE, sep=",", dec=".")
str(sumd2)
sumd2$diag <- as.factor(sumd2$diag)
sumd2$gender <- as.factor(sumd2$gender)
sumd2$Layer <- as.factor(sumd2$Layer)
str(sumd2)
```

## **Linear mixed model applied on SMI 311+ cell densities**

```{r, echo=FALSE}
ggplot(sumd2, aes(x=Layer, y=SMI, color=diag)) +
  geom_point(position = position_jitterdodge(), size=2)+
  scale_color_manual(values=c("#00CED1", "#FA8072"))+
  theme_light()+
  ggtitle("Layerwise density of SMI 311+ cells") +
  xlab("Cortical layers") + ylab("Density (cell/cm^2)")+
  theme(text = element_text(size=12))
```

```{r}
all_in = lme(SMI ~ diag*Layer+pmi+gender+age+Layer:age+Layer:pmi, random = ~1|ID, data=sumd2)
summary(all_in)
qqnorm(resid(all_in))
qqline(resid(all_in))
reff = ranef(all_in)
qqnorm(reff[["(Intercept)"]])
qqline(reff[["(Intercept)"]])
hist(reff[["(Intercept)"]]) 

#layerwise contrast matrices 
Kontall =         rbind("Layer=2, diag=ctr" = c(1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), 
                        "Layer=2, diag=sch" = c(1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0))
Kontall

Kont_kulallSMI = rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0))

kont_LallSMI = glht(all_in, linfct=Kont_kulallSMI)
summary(kont_LallSMI)
confint(kont_LallSMI)
```

### *Model diagnostics are not perfect, but okay.*
### *No significant effect of age, gender, pmi was detected, but age is in signif interaction with layer 2*
### *No significant effect of SCH diagnose on density in any layer was detected.*
```{r}
smi = lme(SMI ~ diag*Layer, random = ~1|ID, data=sumd2)
summary(smi)
qqnorm(resid(smi))
qqline(resid(smi))
reff = ranef(smi)
qqnorm(reff[["(Intercept)"]])
qqline(reff[["(Intercept)"]])
hist(reff[["(Intercept)"]]) 

#L2
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1))

kont_LP2 = glht(smi, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

```


## **Linear mixed model applied on NPY+ cell densities**

```{r, echo=FALSE}
ggplot(sumd2, aes(x=Layer, y=npy, color=diag)) +
  geom_point(position = position_jitterdodge(), size=2)+
  scale_color_manual(values=c("#00CED1", "#FA8072"))+
  theme_light()+
  ggtitle("Layerwise density of NPY+ cells") +
  xlab("Cortical layers") + ylab("Density (cell/cm^2)")+
  theme(text = element_text(size=12))
```

```{r}
all_inNPY = lme(npy ~ diag*Layer+pmi+gender+age+Layer:pmi, random = ~1|ID, data=sumd2)
summary(all_inNPY)
qqnorm(resid(all_inNPY))
qqline(resid(all_inNPY))
reff = ranef(all_inNPY)
qqnorm(reff[["(Intercept)"]])
qqline(reff[["(Intercept)"]])
hist(reff[["(Intercept)"]])

#layerwise contrast matrices 
Kontall =         rbind("Layer=2, diag=ctr" = c(1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), 
                        "Layer=2, diag=sch" = c(1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0))
Kontall

Kont_kulallNPY =   rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 2, 0, 0))

kont_LallNPY = glht(all_inNPY, linfct=Kont_kulallNPY)
summary(kont_LallNPY)
confint(kont_LallNPY)

```

### *Model diagnostics are not perfect, but okay...*
### *No significant effect (or interaction) of age, gender, pmi was detected.*
### *The significant interaction between SCH and CTR in Layer 4 with a negative value (-241.021, p=0.0267) indicates lower NPY cell density in L4.*
```{r}
npy = lme(npy ~ diag*Layer, random = ~1|ID, data=sumd2)
summary(npy)
qqnorm(resid(npy))
qqline(resid(npy))
reff = ranef(npy)
qqnorm(reff[["(Intercept)"]])
qqline(reff[["(Intercept)"]])
hist(reff[["(Intercept)"]])

#L2
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0))

kont_LP2 = glht(npy, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L3
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0))

kont_LP2 = glht(npy, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L4
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0))

kont_LP2 = glht(npy, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L5
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0))

kont_LP2 = glht(npy, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L6
KontP =       rbind("Layer=6, diag=ctr" = c(1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0), 
                    "Layer=6, diag=sch" = c(1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1))
KontP

Kont_kulP2 =  rbind("Layer=6, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1))

kont_LP2 = glht(npy, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)
```


## **Linear mixed model applied on CB+ cell densities**

```{r, echo=FALSE}
ggplot(sumd2, aes(x=Layer, y=calbindin, color=diag)) +
  geom_point(position = position_jitterdodge(), size=2)+
  scale_color_manual(values=c("#00CED1", "#FA8072"))+
  theme_light()+
  ggtitle("Layerwise density of CB+ cells") +
  xlab("Cortical layers") + ylab("Density (cell/cm^2)")+
  theme(text = element_text(size=12))
```

```{r}
all_inCB = lme(calbindin ~ diag*Layer+pmi+gender+age+Layer:pmi, random = ~1|ID, data=sumd2)
summary(all_inCB)
qqnorm(resid(all_inCB))
qqline(resid(all_inCB))
reff = ranef(all_inCB)
qqnorm(reff[["(Intercept)"]])
qqline(reff[["(Intercept)"]])
hist(reff[["(Intercept)"]])
performance::r2(all_inCB)

#Layerwise
Kontallcb =       rbind("Layer=2, diag=ctr" = c(1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), 
                        "Layer=2, diag=sch" = c(1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0))
Kontallcb

Kont_kul2allcb =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0))

kont_L2all = glht(all_inCB, linfct=Kont_kul2allcb)
summary(kont_L2all)
confint(kont_L2)
```

```{r}
cb = lme(calbindin ~ diag*Layer, random = ~1|ID, data=sumd2)
summary(cb)
qqnorm(resid(cb))
qqline(resid(cb))
reff = ranef(cb)
qqnorm(reff[["(Intercept)"]])
qqline(reff[["(Intercept)"]])
hist(reff[["(Intercept)"]])

#L2
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0))

kont_LP2 = glht(cb, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L3
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0))

kont_LP2 = glht(cb, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L4
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0))

kont_LP2 = glht(cb, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L5
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0))

kont_LP2 = glht(cb, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L6
KontP =       rbind("Layer=6, diag=ctr" = c(1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0), 
                    "Layer=6, diag=sch" = c(1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1))
KontP

Kont_kulP2 =  rbind("Layer=6, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1))

kont_LP2 = glht(cb, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)
```


## **Linear mixed model applied on Nissl+ cell densities**

```{r, echo=FALSE}
ggplot(sumd2, aes(x=Layer, y=nissl, color=diag)) +
  geom_point(position = position_jitterdodge(), size=2)+
  scale_color_manual(values=c("#00CED1", "#FA8072"))+
  theme_light()+
  ggtitle("Layerwise density of Nissl+ cells") +
  xlab("Cortical layers") + ylab("Density (cell/cm^2)")+
  theme(text = element_text(size=12))
```

```{r}
all_inNISSL = lme(nissl ~ diag*Layer+pmi+gender+age+Layer:pmi, random = ~1|ID, data=sumd2)
summary(all_inNISSL)
qqnorm(resid(all_inNISSL))
qqline(resid(all_inNISSL))
reff = ranef(all_inNISSL)
qqnorm(reff[["(Intercept)"]])
qqline(reff[["(Intercept)"]])
hist(reff[["(Intercept)"]])

#Layerwise contrast matrices 
Kontallnissl =       rbind("Layer=2, diag=ctr" = c(1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), 
                        "Layer=2, diag=sch" = c(1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0))
Kontallnissl

Kont_kulallnissl =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0))

kont_L2all = glht(all_inNISSL, linfct=Kont_kulallnissl)
summary(kont_L2all)
confint(kont_L2)

```
### *Model diagnostics are okay-ish*
### *Weakly significant decrease in SCH Layer 2 (p=0.0358), significant increase in SCH Layer 4 (p=0.0029)*

```{r}
nissl = lme(nissl ~ diag*Layer, random = ~1|ID, data=sumd2)
summary(nissl)
qqnorm(resid(nissl))
qqline(resid(nissl))
reff = ranef(nissl)
qqnorm(reff[["(Intercept)"]])
qqline(reff[["(Intercept)"]])
hist(reff[["(Intercept)"]])

lsmeans(nissl, pairwise~Layer*diag, adjust="tukey")

summary(glht(nissl, linfct=mcp(Layer="Tukey")))

#L2
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0))

kont_LP2 = glht(nissl, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L3
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0))

kont_LP2 = glht(nissl, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L4
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0))

kont_LP2 = glht(nissl, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L5
KontP =       rbind("Layer=2, diag=ctr" = c(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0), 
                    "Layer=2, diag=sch" = c(1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0))
KontP

Kont_kulP2 =  rbind("Layer=2, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0))

kont_LP2 = glht(nissl, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)

#L6
KontP =       rbind("Layer=6, diag=ctr" = c(1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0), 
                    "Layer=6, diag=sch" = c(1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1))
KontP

Kont_kulP2 =  rbind("Layer=6, diag=2-1" = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1))

kont_LP2 = glht(nissl, linfct=Kont_kulP2)
summary(kont_LP2)
confint(kont_LP2)
```
```

## **However........!!!**
```{r}
all_inNISSLplus = lme(nissl ~ diag*Layer+pmi+gender+age+Layer:pmi, random = ~1|ID, data=sumd2)
summary(all_inNISSLplus)
qqnorm(resid(all_inNISSLplus))
qqline(resid(all_inNISSLplus))
reff = ranef(all_inNISSLplus)
qqnorm(reff[["(Intercept)"]])
qqline(reff[["(Intercept)"]])
hist(reff[["(Intercept)"]])
```
### *it seems, the Layer 2 effect is strongly connected to post mortem interval, and only Layer 4 effect is directly connected with SCH diagnose*







