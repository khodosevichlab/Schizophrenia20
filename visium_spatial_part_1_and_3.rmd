---
title: "Schizo VISIUM"
output: html_notebook
author: "MB"
---


# Import libraries
```{r warning=F, message=F}
library("Seurat")
library(sctransform)
library(readr)
library(magrittr)
library(conos)
library(pagoda2)
library(data.table)
library("scrattch.io")
library("parallel")
library("future") #for seurat parallelization https://satijalab.org/seurat/v3.0/future_vignette.html
library("ggplot2")
library("pals")
library(gridExtra)
library("patchwork")
library(tidyr)
library(reshape2) #for melt to reshate data frames
library(dplyr)
library("car") #leveneTest
library("ggsignif") #geom_signif stat_signif
library(scales) #for different formating of scale numbers
library("Matrix")


```



# Import data


## Import annotations and Allen data

```{r}
#schizo annotations and subtype orders
annotations_scz2 <- read_rds(
  "~/projects/human_schizo/MB6-MB23/2ndary/ctx_layers_SCZ_ALLEN/rds_objects/annotations_scz2.rds")

hsub_order <- read_rds("~/projects/human_schizo/MB6-MB23/2ndary/ctx_layers_SCZ_ALLEN/rds_objects/hsub_order.rds")
msub_order <- read_rds("~/projects/human_schizo/MB6-MB23/2ndary/ctx_layers_SCZ_ALLEN/rds_objects/msub_order.rds")





palette_45_2 <- read_rds("~/projects/human_schizo/MB6-MB23/2ndary/ctx_layers_SCZ_ALLEN/rds_objects/palette_45_2.rds")
palette_45 <- read_rds("~/projects/human_schizo/MB6-MB23/2ndary/ctx_layers_SCZ_ALLEN/rds_objects/palette_45.rds")
palette_45_3 <- c(
as.vector(polychrome(36)),
as.vector(alphabet(10))
)

```


## Variables

```{r}
#Seurat renames - to ., so sample names are with . here

samplegroups <- list(
  control = c('MB7', 'MB9', 'MB11', 'MB13', 'MB15', 'MB16', 'MB17', 'MB19', 'MB20', 'MB21', 'MB18.2'),
  schizo = c('MB6', 'MB10', 'MB12', 'MB14', 'MB22', 'MB23','MB8.2')
)
diseasef <- as.factor(setNames(rep(names(samplegroups),unlist(lapply(samplegroups,length))),unlist(samplegroups)))



#or use old type with - in names
samplegroups2 <- list(
  control = c('MB7', 'MB9', 'MB11', 'MB13', 'MB15', 'MB16', 'MB17', 'MB19', 'MB20', 'MB21', 'MB18-2'),
  schizo = c('MB6', 'MB10', 'MB12', 'MB14', 'MB22', 'MB23','MB8-2')
)
diseasef2 <- as.factor(setNames(rep(names(samplegroups2),unlist(lapply(samplegroups2,length))),unlist(samplegroups2)))




```






## Import schzio data mapped against Allen genome
```{r}
cms_scz <- lapply(setNames(c("MB14", "MB15", "MB17"), c("MB14", "MB15", "MB17")), function(smplname){
             cm <- Seurat::Read10X_h5(
                paste0("/home/mbatiuk/projects/human_schizo/MB6-MB23/counts_Allen_Genome/MB14_MB15_MB17_proper_gtf/",
                       smplname, "/outs/filtered_feature_bc_matrix.h5"
                       ))
             
             colnames(cm) <- paste0(smplname, "_", colnames(cm))
             
             cm
  
  
  
  
}
)



```







## Plotting functions

### Signif function - p val to *

```{r}
#Define Significance function for changing p values to *
signif <- function(x) {
  
  y <- x
  y[x <= 0.001] <- "***"
  y[x <= 0.01 & x > 0.001] <- "**"
  y[x <= 0.05 & x > 0.01] <- "*"
  y[x > 0.05] <- "NS"
  y[is.nan(x)] <- NaN
  y[is.na(x) & !is.nan(x)] <- NA
 
  
  
  
  return(y)
}

```



### null.length function - to make NULL if annotation vector has 0 lenght

```{r}

null.lenth.signif <- function(x, y) {
  
  if (signif(x)[pastes(y)][
        x[pastes(y)] <= 0.05 & !is.na(x[pastes(y)])] %>% length > 0) {
  
  
  signif(x)[pastes(y)][
        x[pastes(y)] <= 0.05 & !is.na(x[pastes(y)])]
  
  
} else {
          
  NULL
        }

  
}
  





null.length <- function(vect, x, y) {
  
  if (x[pastes(y)][
        x[pastes(y)] <= 0.05 & !is.na(x[pastes(y)])] %>% length > 0) {
  
  
  vect[
        x[pastes(y)] <= 0.05 & !is.na(x[pastes(y)])]
  
  
} else {
          
  NULL
        }

  
}





```


```{r}
null.length.signif2 <- function(x) {
  
  if (signif(x)[
        x <= 0.05 & !is.na(x)] %>% length > 0) {
  
  
  signif(x)[
        x <= 0.05 & !is.na(x)]
  
  
} else {
          
  NULL
        }

  
}
  





null.length.2 <- function(vect, x) {
  
  if (x[
        x <= 0.05 & !is.na(x)] %>% length > 0) {
  
  
  vect[
        x <= 0.05 & !is.na(x)]
  
  
} else {
          
  NULL
        }

  
}
```



### pastes function to paste subtype name + layer in plots comfortably

```{r}

pastes <- function(x) {
  c(paste0(x, ".L1"), paste0(x, ".L2"), paste0(x, ".L3"), paste0(x, ".L4"), paste0(x, ".L5"),
     paste0(x, ".L6")#,  paste0(x, ".WM")
    )
  
  
}


```




# Prepare Allen 10x v3 data for Stereoscope analysis

```{r}




#Allen v3 10x M1 metadata: https://idk-etl-prod-download-bucket.s3.amazonaws.com/aibs_human_m1_10x/metadata.csv

allen.10x.m1.annot <- read.csv("~/projects/human_schizo/MB6-MB23/2ndary/schizo_visium/Allen_10x_m1_2020/metadata.csv")








#Allen data 10x v3 from https://idk-etl-prod-download-bucket.s3.amazonaws.com/aibs_human_m1_10x/matrix.csv
allen_10x_cm <- fread("./Allen_10x_m1_2020/matrix.csv")




allen_10x_cm %<>%
  data.frame(row.names = 1) %>% t %>% Matrix(sparse = T)



allen_10x_cm_non_neural <- allen_10x_cm[, colnames(allen_10x_cm) %in%
  
      allen.10x.m1.annot$sample_name[allen.10x.m1.annot$class_label == "Non-Neuronal"]]

#save non-neural countmatrices
#write_rds(allen_10x_cm_non_neural, "./rds_objects/allen_10x_m1_non_neur.rds")


#make annotations:

anno_allen_10x <- list(

  med = 
        
          setNames(allen.10x.m1.annot[allen.10x.m1.annot$class_label == "Non-Neuronal", ]$subclass_label, 
                   allen.10x.m1.annot[allen.10x.m1.annot$class_label == "Non-Neuronal", ]$sample_name),

  high =  setNames(allen.10x.m1.annot[allen.10x.m1.annot$class_label == "Non-Neuronal", ]$cell_type_alias_label, 
                   allen.10x.m1.annot[allen.10x.m1.annot$class_label == "Non-Neuronal", ]$sample_name),


  origin =   setNames(allen.10x.m1.annot[allen.10x.m1.annot$class_label == "Non-Neuronal", ]$external_donor_name_label, 
                   allen.10x.m1.annot[allen.10x.m1.annot$class_label == "Non-Neuronal", ]$sample_name)
    
    
    
    
)



#save annotation

#write_rds(anno_allen_10x, "./rds_objects/anno_allen_10x.rds")




```







# Plot stereoscope results, visum + oursc + allen M1C 10x v3 glia


## import stereoscope matrices and re-import layer annotation


```{r}


#import layer annotation with MB18-2 as MB18-2

layers.filter.list2 <- lapply(
  setNames(c("MB11", "MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"),
  c("MB11", "MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")),
  
  function(x) {
    df <- read.csv(paste0("/home/mbatiuk/projects/human_schizo/MB6-MB23/2ndary/schizo_visium/layers_filtered/", x, ".csv"), 
             header = T)
    setNames(df[, 2], df[, 1])
    
    
  }
  
  
    
    
  )














stereo.med <- lapply(setNames(c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"), 
                                c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")), function(x) {
                       y <-        read.delim(paste0("/home/viktor_petukhov/Data/Schizophrenia/deconv_v2/stereoscope_res/",
                                                    x, "_cm.tsv"), row.names = 1)
                       
                       #filter low quality spots
                                    
   y[rownames(y) %in% names(layers.filter.list2[[x]]), ]

                                }
  
  
)





str(stereo.med)




# High res

stereo.high <- lapply(setNames(c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"), 
                                c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")), function(x) {
                       y <-        read.delim(paste0("/d0/home/viktor_petukhov/Data/Schizophrenia/deconv_v2/stereoscope_res_high/",
                                                    x, "_cm.tsv"), row.names = 1)
                       
                       #filter low quality spots
                                    
   y[rownames(y) %in% names(layers.filter.list2[[x]]), ]

                                }
  
  
)


#correct subtype names


stereo.high <- lapply(setNames(c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"), 
                                c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")), function(x) {
                       y <- stereo.high[[x]]
                       
                       #change rownames
                                    
   colnames(y) <- colnames(y) %>% gsub("\\.", "_", x = .)
   y

                                }
  
  
)





stereo.med <- lapply(setNames(c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"), 
                                c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")), function(x) {
                       y <- stereo.med[[x]]
                       
                       #change rownames
                                    
   colnames(y) <- colnames(y) %>% gsub("\\.", "_", x = .)
   y

                                }
  
  
)





```



## check which layers were used for prediction

```{r}




#check layer annotation for each sample


lapply(setNames(c("MB11", "MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"),
  c("MB11", "MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")), function(x) {
    
  layers.filter.list2[[x]][rownames(stereo.med[[x]])] %>% table
    
    
  })

#OK, WM is present; Filter on later stage



lapply(setNames(c("MB11", "MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"),
  c("MB11", "MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")), function(x) {
    
  layers.filter.list2[[x]][rownames(stereo.high[[x]])] %>% table
    
    
  })




```




## Variables

```{r}
hsub_order_allen_10x <- factor(c(hsub_order[-c(length(hsub_order), length(hsub_order) -1)], 
                            "Astro_L1_FGFR3_SERPINI2", "Astro_L1_6_FGFR3_AQP1", "Astro_L1_6_FGFR3_PLCG1", 
                            "Oligo_L2_6_OPALIN_FTH1P3", "Oligo_L3_6_OPALIN_ENPP6", "Oligo_L2_6_OPALIN_MAP6D1",
                            "Oligo_L5_6_OPALIN_LDLRAP1", "OPC_L1_6_PDGFRA_COL20A1", "Micro_L1_6_TYROBP_CD74", 
                            "Endo_L2_5_NOSTRIN_SRGN", "VLMC_L1_5_PDGFRA_COLEC12"), 
                           
                           levels = c(hsub_order[-c(length(hsub_order), length(hsub_order) -1)], 
                             "Astro_L1_FGFR3_SERPINI2", "Astro_L1_6_FGFR3_AQP1", "Astro_L1_6_FGFR3_PLCG1", 
                            "Oligo_L2_6_OPALIN_FTH1P3", "Oligo_L3_6_OPALIN_ENPP6", "Oligo_L2_6_OPALIN_MAP6D1",
                            "Oligo_L5_6_OPALIN_LDLRAP1", "OPC_L1_6_PDGFRA_COL20A1", "Micro_L1_6_TYROBP_CD74", 
                            "Endo_L2_5_NOSTRIN_SRGN", "VLMC_L1_5_PDGFRA_COLEC12"), 
                           
                           
                           ordered = T)





msub_order_allen_10x <- factor(c(msub_order[-c(length(msub_order), length(msub_order) -1)], 
                            "Astro", "Oligo", "OPC", "Micro_PVM", "Endo", "VLMC"), 
                           
                           levels = c(msub_order[-c(length(msub_order), length(msub_order) -1)], 
                             "Astro", "Oligo", "OPC", "Micro_PVM", "Endo", "VLMC"), 
                           
                           
                           ordered = T)





```




## Filter WM - not well represented in Scz and has variable size - skew in bulk analysis. Make data frames

```{r}
#MED

predict.stereo.med <- 

  lapply(setNames(c("MB11", "MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"),
  c("MB11", "MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")), function(x) {




  t(stereo.med[[x]])[, names(layers.filter.list2[[x]][!layers.filter.list2[[x]] == "WM"])] %>% 
   apply(1, mean)
  }
) %>% as.data.frame %>% data.frame(subtypes = factor(rownames(.), levels = msub_order_allen_10x), .)


predict.stereo.med.melt <- melt(predict.stereo.med, id.vars = "subtypes", variable.name = "samples", 
                          value.name = "Mean probability")


#add condition

predict.stereo.med.melt$condition <- diseasef[predict.stereo.med.melt$samples %>% as.vector]







#HIGH

predict.stereo.high <- 

  lapply(setNames(c("MB11", "MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"),
  c("MB11", "MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")), function(x) {




  t(stereo.high[[x]])[, names(layers.filter.list2[[x]][!layers.filter.list2[[x]] == "WM"])] %>% 
   apply(1, mean)
  }
) %>% as.data.frame %>% data.frame(subtypes = factor(rownames(.), levels = hsub_order_allen_10x), .)


predict.stereo.high.melt <- melt(predict.stereo.high, id.vars = "subtypes", variable.name = "samples", 
                          value.name = "Mean probability")


#add condition

predict.stereo.high.melt$condition <- diseasef[predict.stereo.high.melt$samples %>% as.vector]


```












## LAYERS stereo data frames


```{r}
#MED LAYERS
stereo.med.layers <- lapply(setNames(c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"), 
                                c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")), function(x) {
                   y <- read.delim(paste0("/home/viktor_petukhov/Data/Schizophrenia/deconv_v2/stereoscope_res/",
                                                    x, "_cm.tsv"), row.names = 1) %>% t
       
       #correct annotations                 
  rownames(y) <- rownames(y) %>% gsub("\\.", "_", x = .)                       
                   
                   
                   
                   #filter low quality spots
                                    
   y[, colnames(y) %in% names(layers.filter.list2[[x]])] %>%


 
  data.frame(subtypes = factor(rownames(.), levels = msub_order_allen_10x), .) %>%
  melt(id.vars = "subtypes", variable.name = "barcodes", value.name = "probability") %>%
  cbind(., sample = rep(x, dim(.)[1])) %>% cbind(., condition = 
                                                                diseasef2[rep(x, dim(.)[1])]) %>%
  cbind(., layer = `[`(layers.filter.list2[[x]], .[["barcodes"]])) %>%
                                   
  group_by(., subtypes, sample, condition, layer) %>% summarize_at(., "probability", 
                                                list(mean_probability = mean, spot_number = length))


}
)











stereo.med.layers.comb <- bind_rows(stereo.med.layers)

#Filter out areas/layers with less than 5 spots

stereo.med.layers.comb.filt <- stereo.med.layers.comb[stereo.med.layers.comb$spot_number > 5, ]


#Filter out WM

stereo.med.layers.comb.filt <- stereo.med.layers.comb.filt[
  !stereo.med.layers.comb.filt$layer == "WM",]







#HIGH LAYERS
stereo.high.layers <- lapply(setNames(c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"), 
                                c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")), function(x) {
                   y <- read.delim(paste0("/d0/home/viktor_petukhov/Data/Schizophrenia/deconv_v2/stereoscope_res_high/",
                                                    x, "_cm.tsv"), row.names = 1) %>% t
      
  #correct annotations                 
  rownames(y) <- rownames(y) %>% gsub("\\.", "_", x = .)                 
                   
                   
   #filter low quality spots
                                    
   y[, colnames(y) %in% names(layers.filter.list2[[x]])] %>%


 
  data.frame(subtypes = factor(rownames(.), levels = hsub_order_allen_10x), .) %>%
  melt(id.vars = "subtypes", variable.name = "barcodes", value.name = "probability") %>%
  cbind(., sample = rep(x, dim(.)[1])) %>% cbind(., condition = 
                                                                diseasef2[rep(x, dim(.)[1])]) %>%
  cbind(., layer = `[`(layers.filter.list2[[x]], .[["barcodes"]])) %>%
                                   
  group_by(., subtypes, sample, layer, condition) %>% summarize_at(., "probability", 
                                                list(mean_probability = mean, spot_number = length))


}
)











stereo.high.layers.comb <- bind_rows(stereo.high.layers)

#Filter out areas/layers with less than 5 spots

stereo.high.layers.comb.filt <- stereo.high.layers.comb[stereo.high.layers.comb$spot_number > 5, ]


#Filter out WM

stereo.high.layers.comb.filt <- stereo.high.layers.comb.filt[
  !stereo.high.layers.comb.filt$layer == "WM",]





   
   
```

##Stats stereoscope with Layers

### Normality, layers, Shapiro-Wilk

```{r}
#Medium resolution

stereo.med.layers.comb.filt.list <- 
    split(stereo.med.layers.comb.filt, f = stereo.med.layers.comb.filt$layer) %>% lapply(., function(x) {
      split(x, f = x$subtypes)
}) %>% unlist(recursive = F) %>% lapply(., function(x) {
      split(x, f = x$condition)
}) %>% unlist(recursive = F)







shapiro.stereo.layer.med <-
  lapply(stereo.med.layers.comb.filt.list, function(x) {tryCatch(shapiro.test(x$mean_probability),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.med %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length





#HIGH resolution

stereo.high.layers.comb.filt.list <- 
    split(stereo.high.layers.comb.filt, f = stereo.high.layers.comb.filt$layer) %>% lapply(., function(x) {
      split(x, f = x$subtypes)
}) %>% unlist(recursive = F) %>% lapply(., function(x) {
      split(x, f = x$condition)
}) %>% unlist(recursive = F)







shapiro.stereo.layer.high <-
  lapply(stereo.high.layers.comb.filt.list, function(x) {tryCatch(shapiro.test(x$mean_probability),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.high %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length




#p<0.05 - non-normal distribution; p>0.05 - normal distribution
```

There are 19 in med and 48 in high groups with non-normal distribution so use same non-parametric test for all


### Normality, layers, Shapiro-Wilk log-transform

```{r}
#Medium resolution

stereo.med.layers.comb.filt.list.log <- lapply(stereo.med.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_log = log1p(mean_probability))
  x
}
)






shapiro.stereo.layer.med.log <-
  lapply(stereo.med.layers.comb.filt.list.log, function(x) {tryCatch(shapiro.test(x$mean_probability_log),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.med.log %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length





#HIGH resolution

stereo.high.layers.comb.filt.list.log <- lapply(stereo.high.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_log = log1p(mean_probability))
  x
}
)






shapiro.stereo.layer.high.log <-
  lapply(stereo.high.layers.comb.filt.list.log, function(x) {tryCatch(shapiro.test(x$mean_probability_log),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.high.log %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length




#p<0.05 - non-normal distribution; p>0.05 - normal distribution
```
no improvement comparing to w/o transformation


### Normality, layers, Shapiro-Wilk log(max(x+1) - x)-transform

```{r}
#Medium resolution

stereo.med.layers.comb.filt.list.logmax <- lapply(stereo.med.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_log = log(max(mean_probability + 1) - mean_probability))
  x
}
)






shapiro.stereo.layer.med.logmax <-
  lapply(stereo.med.layers.comb.filt.list.logmax, function(x) {tryCatch(shapiro.test(x$mean_probability_log),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.med.logmax %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length





#HIGH resolution

stereo.high.layers.comb.filt.list.logmax <- lapply(stereo.high.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_log = log(max(mean_probability + 1) - mean_probability))
  x
}
)






shapiro.stereo.layer.high.logmax <-
  lapply(stereo.high.layers.comb.filt.list.logmax, function(x) {tryCatch(shapiro.test(x$mean_probability_log),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.high.logmax %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length




#p<0.05 - non-normal distribution; p>0.05 - normal distribution
```
much worse


### Normality, layers, Shapiro-Wilk sqrt-transform

```{r}
#Medium resolution

stereo.med.layers.comb.filt.list.sqrt <- lapply(stereo.med.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_sqrt = sqrt(mean_probability))
  x
}
)






shapiro.stereo.layer.med.sqrt <-
  lapply(stereo.med.layers.comb.filt.list.sqrt, function(x) {tryCatch(shapiro.test(x$mean_probability_sqrt),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.med.sqrt %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length





#HIGH resolution

stereo.high.layers.comb.filt.list.sqrt <- lapply(stereo.high.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_sqrt = sqrt(mean_probability))
  x
}
)






shapiro.stereo.layer.high.sqrt <-
  lapply(stereo.high.layers.comb.filt.list.sqrt, function(x) {tryCatch(shapiro.test(x$mean_probability_sqrt),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.high.sqrt %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length




#p<0.05 - non-normal distribution; p>0.05 - normal distribution
```
small improvement

### Normality, layers, Shapiro-Wilk sqrt(max(x+1) - x)-transform

```{r}
#Medium resolution

stereo.med.layers.comb.filt.list.sqrtmax <- lapply(stereo.med.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_sqrt = sqrt(max(mean_probability+1) - mean_probability))
  x
}
)






shapiro.stereo.layer.med.sqrtmax <-
  lapply(stereo.med.layers.comb.filt.list.sqrtmax, function(x) {tryCatch(shapiro.test(x$mean_probability_sqrt),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.med.sqrtmax %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length





#HIGH resolution

stereo.high.layers.comb.filt.list.sqrtmax <- lapply(stereo.high.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_sqrt = sqrt(max(mean_probability+1) - mean_probability))
  x
}
)






shapiro.stereo.layer.high.sqrtmax <-
  lapply(stereo.high.layers.comb.filt.list.sqrtmax, function(x) {tryCatch(shapiro.test(x$mean_probability_sqrt),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.high.sqrtmax %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length




#p<0.05 - non-normal distribution; p>0.05 - normal distribution
```
even worse



### Normality, layers, Shapiro-Wilk reciprocal-transform

```{r}
#Medium resolution

stereo.med.layers.comb.filt.list.recip <- lapply(stereo.med.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_recip = 1/mean_probability)
  x
}
)






shapiro.stereo.layer.med.recip <-
  lapply(stereo.med.layers.comb.filt.list.recip, function(x) {tryCatch(shapiro.test(x$mean_probability_recip),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.med.recip %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length





#HIGH resolution

stereo.high.layers.comb.filt.list.recip <- lapply(stereo.high.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_recip = 1/mean_probability)
  x
}
)






shapiro.stereo.layer.high.recip <-
  lapply(stereo.high.layers.comb.filt.list.recip, function(x) {tryCatch(shapiro.test(x$mean_probability_recip),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.high.recip %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length




#p<0.05 - non-normal distribution; p>0.05 - normal distribution
```
worse


### Normality, layers, Shapiro-Wilk 1/(max(x+1) - x)-transform

```{r}
#Medium resolution

stereo.med.layers.comb.filt.list.recipmax <- lapply(stereo.med.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_recip = 1/(max(mean_probability+1) - mean_probability))
  x
}
)






shapiro.stereo.layer.med.recipmax <-
  lapply(stereo.med.layers.comb.filt.list.recipmax, function(x) {tryCatch(shapiro.test(x$mean_probability_recip),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.med.recipmax %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length





#HIGH resolution

stereo.high.layers.comb.filt.list.recipmax <- lapply(stereo.high.layers.comb.filt.list, function(x) {
  x %<>% mutate(mean_probability_recip = 1/(max(mean_probability+1) - mean_probability))
  x
}
)






shapiro.stereo.layer.high.recipmax <-
  lapply(stereo.high.layers.comb.filt.list.recipmax, function(x) {tryCatch(shapiro.test(x$mean_probability_recip),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.high.recipmax %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length




#p<0.05 - non-normal distribution; p>0.05 - normal distribution
```
even worse


### Normality, layers, Shapiro-Wilk box-cox transformation

```{r}
#Medium resolution

stereo.med.layers.comb.filt.list.bc <- 
    split(stereo.med.layers.comb.filt, f = stereo.med.layers.comb.filt$layer) %>% lapply(., function(x) {
      split(x, f = x$subtypes)
}) %>% unlist(recursive = F)


#box-cox transform

stereo.med.layers.comb.filt.list.bc <-
    lapply(stereo.med.layers.comb.filt.list.bc, function(z) {
     bc_result <- boxCox(z$mean_probability ~ z$condition, plotit = F)
    
    opt.lambda <- bc_result$x[which.max(bc_result$y)]
    
    z %<>% mutate(freq_bc = bcPower(mean_probability, lambda = opt.lambda))
    z
    }
    )

#further split by condition:

#stereo.med.layers.comb.filt.list.bc <- lapply(stereo.med.layers.comb.filt.list.bc, function(x) {
#    split(x, f = x$condition)
#}
#) %>% unlist(recursive = F)





shapiro.stereo.layer.med.bc <-
  lapply(stereo.med.layers.comb.filt.list.bc, function(x) {tryCatch(shapiro.test(x$mean_probability),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.med.bc %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length





#HIGH resolution

stereo.high.layers.comb.filt.list.bc <- 
    split(stereo.high.layers.comb.filt, f = stereo.high.layers.comb.filt$layer) %>% lapply(., function(x) {
      split(x, f = x$subtypes)
}) %>% unlist(recursive = F)



#box-cox transform

stereo.high.layers.comb.filt.list.bc <-
    lapply(stereo.high.layers.comb.filt.list.bc, function(z) {
     bc_result <- boxCox(z$mean_probability ~ z$condition, plotit = F)
    
    opt.lambda <- bc_result$x[which.max(bc_result$y)]
    
    z %<>% mutate(freq_bc = bcPower(mean_probability, lambda = opt.lambda))
    z
    }
    )

#further split by condition:

#stereo.high.layers.comb.filt.list.bc <- lapply(stereo.high.layers.comb.filt.list.bc, function(x) {
#    split(x, f = x$condition)
#}
#) %>% unlist(recursive = F)





shapiro.stereo.layer.high.bc <-
  lapply(stereo.high.layers.comb.filt.list.bc, function(x) {tryCatch(shapiro.test(x$mean_probability),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.high.bc %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length




#p<0.05 - non-normal distribution; p>0.05 - normal distribution
```
some improvement but still too many with non-normal distribution


### Normality, layers, Shapiro-Wilk Yeo-Johnson transformed

```{r}
#Medium resolution

stereo.med.layers.comb.filt.list.yj <- 
    split(stereo.med.layers.comb.filt, f = stereo.med.layers.comb.filt$layer) %>% lapply(., function(x) {
      split(x, f = x$subtypes)
}) %>% unlist(recursive = F)


#Yeo-Johnson transform

stereo.med.layers.comb.filt.list.yj <-
    lapply(stereo.med.layers.comb.filt.list.yj, function(z) {
     bc_result <- boxCox(z$mean_probability ~ z$condition, plotit = F, family = "yjPower")
    
    opt.lambda <- bc_result$x[which.max(bc_result$y)]
    
    z %<>% mutate(mean_probability_yj = yjPower(mean_probability, lambda = opt.lambda))
    z
    }
    )

#further split by condition:

#stereo.med.layers.comb.filt.list.yj <- lapply(stereo.med.layers.comb.filt.list.yj, function(x) {
#    split(x, f = x$condition)
#}
#) %>% unlist(recursive = F)





shapiro.stereo.layer.med.yj <-
  lapply(stereo.med.layers.comb.filt.list.yj, function(x) {tryCatch(shapiro.test(x$mean_probability),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.med.yj %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length





#HIGH resolution

stereo.high.layers.comb.filt.list.yj <- 
    split(stereo.high.layers.comb.filt, f = stereo.high.layers.comb.filt$layer) %>% lapply(., function(x) {
      split(x, f = x$subtypes)
}) %>% unlist(recursive = F)


#Yeo-Johnson transform

stereo.high.layers.comb.filt.list.yj <-
    lapply(stereo.high.layers.comb.filt.list.yj, function(z) {
     bc_result <- boxCox(z$mean_probability ~ z$condition, plotit = F, family = "yjPower")
    
    opt.lambda <- bc_result$x[which.max(bc_result$y)]
    
    z %<>% mutate(mean_probability_yj = yjPower(mean_probability, lambda = opt.lambda))
    z
    }
    )

#further split by condition:

#stereo.high.layers.comb.filt.list.yj <- lapply(stereo.high.layers.comb.filt.list.yj, function(x) {
#    split(x, f = x$condition)
#}
#) %>% unlist(recursive = F)





shapiro.stereo.layer.high.yj <-
  lapply(stereo.high.layers.comb.filt.list.yj, function(x) {tryCatch(shapiro.test(x$mean_probability),
                                                                  error = function(e) NULL)
    
    })



shapiro.stereo.layer.high.yj %>% lapply(function(x) x$p.value) %>% unlist %>% `[`(., (. <= 0.05)) %>% length


#p<0.05 - non-normal distribution; p>0.05 - normal distribution
```
some improvement but still too many with non-normal distribution



### Equality of variances (Levene's test):

```{r}
#Medium resolution
stereo.med.layers.comb.filt.list2 <- 
    split(stereo.med.layers.comb.filt, f = list(stereo.med.layers.comb.filt$subtypes,
                                                 stereo.med.layers.comb.filt$layer
                                                 ))


levene.stereo.med <- lapply(stereo.med.layers.comb.filt.list2, function(x) leveneTest(mean_probability ~ condition, 
                                                                                data = x))

levene.stereo.med.p <-
lapply(levene.stereo.med, function(x) {
  y <- x$`Pr(>F)`[1]
  #return(y)
  
}) 


 sum(unlist(levene.stereo.med.p) <= 0.05)



 
 
 
 
 
 
# HIGH resolution
stereo.high.layers.comb.filt.list2 <- 
    split(stereo.high.layers.comb.filt, f = list(stereo.high.layers.comb.filt$subtypes,
                                                 stereo.high.layers.comb.filt$layer
                                                 ))


levene.stereo.high <- lapply(stereo.high.layers.comb.filt.list2, function(x) leveneTest(mean_probability ~ condition, 
                                                                                data = x))

levene.stereo.high.p <-
lapply(levene.stereo.high, function(x) {
  y <- x$`Pr(>F)`[1]
  #return(y)
  
}) 


 sum(unlist(levene.stereo.high.p) <= 0.05)





#p < 0.05 - unequal variances





```
medium - in most cases variances are equal, except in 8 - not
high in 20 cases variances are not equal



### Independent 2-group Mann-Whitney U test
```{r}
#MED
wilcox.stereo.layer.med <-
  lapply(stereo.med.layers.comb.filt.list2, function(x) {wilcox.test(mean_probability ~ condition, data = x)})
wilcox.stereo.layer.med




#vectorize

wilcox.stereo.layer.med.vec <- lapply(wilcox.stereo.layer.med, function(x) x$p.value) %>% unlist



#correct for multiple comparison
wilcox.stereo.layer.med.vec.adj <- wilcox.stereo.layer.med.vec %>% p.adjust(method = "BH")



(wilcox.stereo.layer.med.vec.adj <= 0.05) %>% sum











#HIGH
wilcox.stereo.layer.high <-
  lapply(stereo.high.layers.comb.filt.list2, function(x) {wilcox.test(mean_probability ~ condition, data = x)})
wilcox.stereo.layer.high




#vectorize

wilcox.stereo.layer.high.vec <- lapply(wilcox.stereo.layer.high, function(x) x$p.value) %>% unlist

#correct for multiple comparison
wilcox.stereo.layer.high.vec.adj <- wilcox.stereo.layer.high.vec %>% p.adjust(method = "BH")



(wilcox.stereo.layer.high.vec.adj <= 0.05) %>% sum



```






## Plot probs with LAYERS


### Proportion probabilities, high resolution

```{r fig.width=12.76, fig.height=15.59}

list.stereo.high.plot <-

    lapply(setNames(hsub_order_allen_10x, hsub_order_allen_10x), function(subt) {
    
    
    ggplot(data = 
             stereo.high.layers.comb.filt[stereo.high.layers.comb.filt[["subtypes"]] == as.character(subt), ], 
            
           
           
            aes(x = layer, y = mean_probability, dodge = condition, fill = condition)) +
      
      
      
        
      
      geom_point(aes(y = mean_probability, color = condition), 
                 position = position_jitterdodge(dodge.width = 0.7, jitter.width = 0.5), 
                   size = 1.1, alpha = 0.3, show.legend = F) +
      
    
      
      
      geom_boxplot(notch = F, outlier.shape = NA, alpha = 0.3, show.legend = F, lwd = 0.4) +
      
      
      
      geom_signif(annotations = null.lenth.signif(wilcox.stereo.layer.high.vec.adj, subt),
                 xmin = null.length(c(0.75:5.75), wilcox.stereo.layer.high.vec.adj, subt), 
                 xmax = null.length(c(1.25:6.25), wilcox.stereo.layer.high.vec.adj, subt), 
                 y_position = null.length(c(rep(
                   
              max(
                stereo.high.layers.comb.filt[stereo.high.layers.comb.filt[["subtypes"]] == 
                                                as.character(subt), ]$mean_probability)*1.1, 6)
              
              
              ), wilcox.stereo.layer.high.vec.adj, subt),
        
                 
                 textsize = 7, vjust = 0.5,
        
       
       
        
                  ) +
      
        theme_bw() +
        
        theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5, size = 11),
              
              axis.title.x = element_blank(),
              axis.text.y = element_text(size = 11),
              axis.title.y = element_text(size = 11),
              legend.title = element_blank(),
              legend.text = element_text(size = 11),
              plot.subtitle = element_text(size = 11, hjust = 0.5, face = "bold"),
              legend.position = "top",
              text = element_text(),
              plot.margin = unit(c(2.5, 13, 2.5, 1), "mm")) +
              labs(subtitle = subt, x = NULL, y = "Mean fraction") +
        scale_color_manual(values = palette_45_2[c(8, 15)]) +
        scale_fill_manual(values = palette_45_2[c(8, 15)]) +
        ylim(min = -0.001, max = max(
          stereo.high.layers.comb.filt[stereo.high.layers.comb.filt[["subtypes"]] == 
                                                as.character(subt), ]$mean_probability)*1.25
        )
        
        
    


}



)


figS.stereo.high.plot <- cowplot::plot_grid(plotlist = list.stereo.high.plot, ncol = 5)

figS.stereo.high.plot




```

```{r}
ggsave(filename = "./plots/figS16.stereo.high.props.plot.pdf", plot = figS.stereo.high.plot, device = cairo_pdf,
       width = 12.76, height = 15.59, units = "in", dpi = 600)
```









# Stereoscpope plot with seurat
## import data
```{r}
visium_allen_plot <- lapply(setNames(c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7"), 
                                c("MB11","MB12", "MB14", "MB15", "MB18-2", "MB22", "MB23", "MB7")),
                       function(smpl) {
                         
                         Load10X_Spatial(paste0(
                           "/home/mbatiuk/projects/human_schizo/MB6-MB23/primary/spatial/counts/Allen_genome/", smpl, "/outs/"), 
                           slice = smpl)
                       }
                       
                       )

names(visium_allen_plot) <- names(visium_allen_plot) %>% gsub("MB18-2", "MB18.2", .)
```

## Import layer labels with filtered out iffy areas

```{r}

layers.filter.list <- lapply(
  setNames(c("MB11", "MB12", "MB14", "MB15", "MB18.2", "MB22", "MB23", "MB7"),
  c("MB11", "MB12", "MB14", "MB15", "MB18.2", "MB22", "MB23", "MB7")),
  
  function(x) {
    df <- read.csv(paste0("/home/mbatiuk/projects/human_schizo/MB6-MB23/2ndary/schizo_visium/layers_filtered/", x, ".csv"), 
             header = T)
    setNames(df[, 2], df[, 1])
    
    
  }
  
  
    
    
  )
  
  


```



## add layers

```{r}

visium_allen_plot <- lapply(setNames(c("MB11", "MB12", "MB14", "MB15", "MB18.2", "MB22", "MB23", "MB7"),
  c("MB11", "MB12", "MB14", "MB15", "MB18.2", "MB22", "MB23", "MB7")),
    function(x) {
  
   #Also set white matter as exclude   
      
   visium_allen_plot[[x]]$Layers <- layers.filter.list[[x]][names(Idents(visium_allen_plot[[x]]))] %>% as.vector %>%
     replace_na("Exclude") %>% gsub("^WM$", "Exclude", .) %>% setNames(names(Idents(visium_allen_plot[[x]])))
   
   visium_allen_plot[[x]]
  
}
  
  
  
  
)





```


## Subset visium seurat objects to remove NAs - no layer annotation, and WM


```{r}


visium_allen_plot <- lapply(visium_allen_plot, function(x) {
                              
                              subset(x, subset = Layers == "Exclude", invert = T)

}
)







```

## Add stereoscope predictions

```{r}








visium_allen_plot <- lapply(setNames(names(visium_allen_plot), names(visium_allen_plot)), function(x) {
  
  anno.med <- stereo.med
  anno.med$MB18.2 <- anno.med$`MB18-2`
  anno.med$`MB18-2` <- NULL
  
  anno.high <- stereo.high
  anno.high$MB18.2 <- anno.high$`MB18-2`
  anno.high$`MB18-2` <- NULL
  
  
  visium_allen_plot[[x]][["Stereo_MED"]] <- anno.med[[x]][names(Idents(visium_allen_plot[[x]])), ] %>% t %>% CreateAssayObject
  visium_allen_plot[[x]][["Stereo_HIGH"]] <- anno.high[[x]][names(Idents(visium_allen_plot[[x]])), ] %>% t %>% CreateAssayObject
  
  visium_allen_plot[[x]]
  
  
}

)


visium_allen_plot$MB14@assays$Stereo_MED[1:10, 1:3]


```


## Plot MED Stereo with Seurat
```{r fig.width=15, fig.height=80}

#set default assay for plotting

visium_allen_plot <- lapply(visium_allen_plot, function(x) {
  DefaultAssay(x) <- "Stereo_MED"
  x
  
  
  
})


#Plot all med subtypes for all samples




plots.seur.stereo.MED <- lapply(setNames(names(visium_allen_plot), names(visium_allen_plot)),
                                      function(x) {
                                        
                    
                        SpatialFeaturePlot(visium_allen_plot[[x]], features = 
                     
                     rownames(visium_allen_plot[[x]][["Stereo_MED"]]),
                   
                   
                   pt.size.factor = 1, ncol = 2, crop = F)
                      
                      #plot.list$layers <- SpatialPlot(visium_allen[[x]], group.by = "Layers", pt.size.factor = 1)
                     # plot.list$plots <- plots
  
  
                                      }
  
  
)

plots.seur.stereo.MED




```



## Plot HIGH Stereo with Seurat
```{r fig.width=15, fig.height=160}

#set default assay for plotting

visium_allen_plot <- lapply(visium_allen_plot, function(x) {
  DefaultAssay(x) <- "Stereo_HIGH"
  x
  
  
  
})


#Plot all med subtypes for all samples




plots.seur.stereo.HIGH <- lapply(setNames(names(visium_allen_plot), names(visium_allen_plot)),
                                      function(x) {
                                        
                    
                        SpatialFeaturePlot(visium_allen_plot[[x]], features = 
                     
                     rownames(visium_allen_plot[[x]][["Stereo_HIGH"]]),
                   
                   
                   pt.size.factor = 1, ncol = 2, crop = F)
                      
                      #plot.list$layers <- SpatialPlot(visium_allen[[x]], group.by = "Layers", pt.size.factor = 1)
                     # plot.list$plots <- plots
  
  
                                      }
  
  
)

plots.seur.stereo.HIGH




```






# Fig7 Visium visualization of subtype positions in tissue

```{r fig.width=12.76, fig.height=15.59}

#set default assay
DefaultAssay(visium_allen_plot$MB11) <- "Stereo_HIGH"



MB11.stereo.plot.list <- 
  
  append(list(Layers =
              SpatialPlot(visium_allen_plot$MB11, group.by = "Layers", pt.size.factor = 1.6, crop = T, cols = palette_45[1:6],
            stroke = 0) + 
  labs(subtitle = "Layers") + theme(plot.subtitle = element_text(size = 11, hjust = 0.5, face = "bold"), 
                            legend.text = element_text(size = 11), legend.position = "bottom", 
                            legend.title = element_blank(),
          plot.margin = unit(c(0, 0, 0, 0), "mm"),
          legend.spacing.x = unit(0, "mm")) +
    guides(fill = guide_legend(override.aes = list(alpha = 1, size = 2), nrow = 1))
  
  
  
  
  
  
  ),
              
              
              
              
              
  
  
  
  
  lapply(setNames(hsub_order_allen_10x %>%
                                           gsub("_", "-", .), hsub_order_allen_10x), function(subt) {
  
  
  
  
  
  
  SpatialPlot(visium_allen_plot[["MB11"]], features = 
                     
                    subt,
                   
                   
                   pt.size.factor = 1.6, crop = T, alpha = c(0.5, 4), stroke = 0
                   ) +
  labs(subtitle = subt %>% gsub("-", "_", .)) +
    theme(plot.subtitle = element_text(size = 11, hjust = 0.5, face = "bold"), 
                                legend.text = element_text(size = 11), legend.position = "bottom", 
                                legend.title = element_blank(), legend.key.width = unit(10, "mm"),
          legend.key.height = unit(3, "mm"),
          plot.margin = unit(c(0, 0, 0, 0), "mm"))
  
  
} )) %>%
    cowplot::plot_grid(plotlist=., ncol=5)



MB11.stereo.plot.list






```

```{r}
ggsave(filename = "./plots/MB11.stereo.plot.list.pdf", plot = MB11.stereo.plot.list, device = cairo_pdf,
       width = 12.76, height = 15.59, units = "in", dpi = 600)
```








#Fig7 Subtype proportions

```{r}
#make common data frame

stereo.combined.df3 <-

      stereo.high.layers.comb.filt[
        
                                    (stereo.high.layers.comb.filt$subtypes == "L2_CUX2_LAMP5_MARCH1" &
                                    stereo.high.layers.comb.filt$layer == "L2") |
        
        
        
                                    (stereo.high.layers.comb.filt$subtypes == "L2_3_CUX2_FREM3_UNC5D" &
                                    stereo.high.layers.comb.filt$layer == "L2") |  
                                      
                                      
                                    (stereo.high.layers.comb.filt$subtypes == "L2_3_CUX2_FREM3_SV2C" &
                                       stereo.high.layers.comb.filt$layer == "L3") |
                                     
                                     (stereo.high.layers.comb.filt$subtypes == "L4_5_FEZF2_LRRK1" &
                                       stereo.high.layers.comb.filt$layer == "L4") |
                                     
                                     (stereo.high.layers.comb.filt$subtypes == "L5_6_FEZF2_TLE4_HTR2C" &
                                       stereo.high.layers.comb.filt$layer == "L5") |
                                     
                                     (stereo.high.layers.comb.filt$subtypes == "ID2_LAMP5_NMBR" &
                                       stereo.high.layers.comb.filt$layer == "L2") |
                                     
                                     (stereo.high.layers.comb.filt$subtypes == "ID2_NCKAP5" &
                                       stereo.high.layers.comb.filt$layer == "L2") |
                                     
                                     (stereo.high.layers.comb.filt$subtypes == "VIP_RELN" &
                                       stereo.high.layers.comb.filt$layer == "L2") |
                                     
                                     (stereo.high.layers.comb.filt$subtypes == "VIP_SEMA3C" &
                                       stereo.high.layers.comb.filt$layer == "L2") |
                                    
                                    
                                    
                                    (stereo.high.layers.comb.filt$subtypes == "SST_TAC3" &
                                    stereo.high.layers.comb.filt$layer == "L6"), 
                                   c("subtypes", "sample", "condition", "mean_probability")]


#rename subtypes with layer information

stereo.combined.df3$subtypes %<>% gsub("L2_3_CUX2_FREM3_UNC5D", "Layer 2 L2_3_CUX2_FREM3_UNC5D", .) %>%
    gsub("L2_3_CUX2_FREM3_SV2C", "Layer 3 L2_3_CUX2_FREM3_SV2C", .) %>%
    gsub("L4_5_FEZF2_LRRK1", "Layer 4 L4_5_FEZF2_LRRK1", .) %>% 
    gsub("L5_6_FEZF2_TLE4_HTR2C", "Layer 5 L5_6_FEZF2_TLE4_HTR2C", .) %>% 
    gsub("ID2_LAMP5_NMBR", "Layer 2 ID2_LAMP5_NMBR", .) %>% 
    gsub("ID2_NCKAP5", "Layer 2 ID2_NCKAP5", .) %>%
    gsub("VIP_RELN", "Layer 2 VIP_RELN", .) %>%
    gsub("VIP_SEMA3C", "Layer 2 VIP_SEMA3C", .) %>%
    gsub("L2_CUX2_LAMP5_MARCH1", "Layer 2 L2_CUX2_LAMP5_MARCH1", .) %>%
    gsub("SST_TAC3", "Layer 6 SST_TAC3", .) %>%
  
  
  factor(., levels = c("Layer 2 L2_CUX2_LAMP5_MARCH1", "Layer 2 L2_3_CUX2_FREM3_UNC5D", "Layer 3 L2_3_CUX2_FREM3_SV2C",
                     "Layer 4 L4_5_FEZF2_LRRK1", "Layer 5 L5_6_FEZF2_TLE4_HTR2C",
                     "Layer 2 ID2_LAMP5_NMBR", "Layer 2 ID2_NCKAP5",
                     "Layer 2 VIP_RELN", "Layer 2 VIP_SEMA3C",
                     "Layer 6 SST_TAC3"))


stereo.combined.df3$condition %<>% gsub("schizo.*", "schizophrenia", .)


#subset wilcoxon results - get subtypes of interest based on snRNAseq
wilcox.stereo.combined.vec.adj2 <-

        wilcox.stereo.layer.high.vec[
          c("L2_CUX2_LAMP5_MARCH1.L2", "L2_3_CUX2_FREM3_UNC5D.L2", "L2_3_CUX2_FREM3_SV2C.L3", "L4_5_FEZF2_LRRK1.L4", 
            "L5_6_FEZF2_TLE4_HTR2C.L5", "ID2_LAMP5_NMBR.L2", "ID2_NCKAP5.L2", "VIP_RELN.L2",
            "VIP_SEMA3C.L2", "SST_TAC3.L6"
           )]

#adjust for multiple comparison

wilcox.stereo.combined.vec.adj2 %<>% p.adjust(method = "BH")

```


## Fig7 Subtype proportions

```{r fig.width=3, fig.height=4.5}

fig4.proport.plot3 <- 

  ggplot(data = stereo.combined.df3, 
         aes(x = subtypes, y = mean_probability, dodge = condition, fill = condition)) +
  
  
  
    
  
  geom_point(aes(y = mean_probability, color = condition), 
             position = position_jitterdodge(dodge.width = 0.7, jitter.width = 0.5), 
               size = 0.8, alpha = 0.4, show.legend = F) +
  

  
  
  geom_boxplot(notch = F, outlier.shape = NA, alpha = 0.3, lwd = 0.4) +
  
  
  
geom_signif(annotations = null.length.signif2(wilcox.stereo.combined.vec.adj2),
             xmin = null.length.2(c(0.8:9.8), wilcox.stereo.combined.vec.adj2), 
             xmax = null.length.2(c(1.2:10.2), wilcox.stereo.combined.vec.adj2), 
             y_position = null.length.2(c(rep(
                   
             
                max(
                stereo.combined.df3$mean_probability)*1.08, 10)), wilcox.stereo.combined.vec.adj2),
             textsize = 5) +
  
    theme_bw() +
    theme(axis.text.x=element_text(size = 11, angle = 90, vjust = 0.5, hjust = 1),
          
          axis.title.x = element_blank(),
         
          axis.text.y = element_text(size = 11),
          axis.title.y = element_text(size = 12),
          legend.title = element_blank(),
          legend.text = element_text(size = 12),
          legend.position = "top",
          legend.margin =  margin(t = -1, b = -3, r = 0, l = 0, unit = "mm"),
          text = element_text(family = "Liberation Sans"),
          plot.subtitle = element_text(size = 15, hjust = 0.9, face = "bold"),
          panel.grid.minor = element_blank()) +
        guides(color = guide_legend(ncol = 2)) +
  
  
          labs(x = NULL, subtitle = "Visium, fractional change", 
               y = "Mean subtype fraction") +
    scale_color_manual(values = palette_45_2[c(8, 15)]) +
    scale_fill_manual(values = palette_45_2[c(8, 15)]) +
    scale_y_continuous(breaks = c(0, 0.04, 0.08), limits = c(0, max(
          stereo.combined.df3$mean_probability)*1.02))

fig4.proport.plot3




```


```{r}
ggsave(filename = "./plots/fig4.proport.plot_march_2021.pdf", plot = fig4.proport.plot3, device = cairo_pdf,
       width = 3, height = 4.5, units = "in", dpi = 600)
```



